<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" CONTENT="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta name="format-detection" content="telephone=no" />
    <title>新疆物流服务平台</title>
    <link rel="stylesheet" type="text/css" href="../css/swiper.min.css"/>
    <link rel="stylesheet" type="text/css" href="../css/commin.css"/>
    <link rel="stylesheet" href="../css/setUp_departmentManage.css">
	<style>
		.contentslist td .btn{color: #6ba1ff}
	</style>
</head>
<body>
<!--结算网点列表-->

    <div class="rightContBox"  style="float: none">
    	<!--头部-->
    	<div class="boxHead">
    		<div class="headLeft">结算网点列表</div>
    		<!--<div class="headRight cfRefresh">-->
    			<!--<img src="../img/yh_refresh2.png"/>-->
    			<!--<span>刷新</span>-->
    		<!--</div>-->
    	</div>
    	<div class="record">
    		<!--<div></div>-->
			<!--<div class="goodsType input select" data-selectedindex="0"><span>排序方式</span><img src="../img/prl-select.jpg" >-->
				<!--<ul>-->
					<!--<li data-index="1">待分配订单</li>-->
					<!--<li data-index="2">进行中订单</li>-->
					<!--<li data-index="3">完成待审核订单</li>-->
					<!--<li data-index="3">已完成订单</li>-->
				<!--</ul>-->
			<!--</div>-->
			<div class="goodsType input select" data-selectedindex="0"><span>显示条数</span><img src="../img/prl-select.jpg" >
				<ul>
					<li data-index="1">待分配订单</li>
					<li data-index="2">进行中订单</li>
					<li data-index="3">完成待审核订单</li>
					<li data-index="3">已完成订单</li>
				</ul>
			</div>
    		<!--<div>排序方式<img src="../img/cf_open.png"/></div>-->
    		<!--<div>显示条数<img src="../img/cf_open.png"/></div>-->
    		<div style="width: 102px;" class="addWangDian">新增网点</div>
    	</div>
    	<div class="listBox">
			<table class="contentslist">
				<thead>
				<tr>
					<th>名称</th>
					<th>所在地</th>
					<th>管理员名称</th>
					<th>联系电话</th>
					<th>网点余额</th>
					<th>网点状态</th>
					<th>操作</th>
				</tr>
				</thead>
				<tbody>
					<!--<tr>-->
						<!--<td>新疆结算网点</td>-->
						<!--<td>新疆-乌鲁木齐</td>-->
						<!--<td>王小二</td>-->
						<!--<td>15311057789</td>-->
						<!--<td>￥5000.00</td>-->
						<!--<td>开启</td>-->
						<!--<td><a class="btn">查看</a><a class="btn">编辑</a><a class="btn">删除</a><a class="btn">关闭</a></td>-->
					<!--</tr>-->
					<!--<tr>-->
						<!--<td>新疆结算网点</td>-->
						<!--<td>新疆-乌鲁木齐</td>-->
						<!--<td>王小二</td>-->
						<!--<td>15311057789</td>-->
						<!--<td>￥5000.00</td>-->
						<!--<td>开启</td>-->
						<!--<td><a class="btn">查看</a><a class="btn">编辑</a><a class="btn">删除</a><a class="btn">关闭</a></td>-->
					<!--</tr>-->
				</tbody>
			</table>
		</div>
		<div class="" style="text-align: center;height: 75px;padding-top: 17px;margin-bottom: 0;border-top: 1px solid #ebe9ea;">
			<ul class="pagination" id="page1" style="position: static;margin-bottom: 0;"></ul>
			<div class="pageJump">
				<span class="allPageN">1/200</span>
				<i style="margin-left: 12px;">共200页</i>，
				<span>到第</span>
				<input type="text"/>
				<span>页</span>
				<button type="button" class="button">GO</button>
			</div>
		</div>

	</div>

<script src="../js/jquery-3.2.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/swiper.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/pager.js" type="text/javascript" charset="utf-8"></script>


<script type="text/javascript" >
    //Iframe 的高度
    $(function () {
        window.parent.$("#Iframe").css("height","853");
    })


//    $('.objListBox>div:nth-child(5n)').css('margin-right','0');
//    Page({
//        num: 200,
//        elem: $('#page1'),
//        callback: function(n) {
//            console.log(n);
//        }
//    });
//    添加网点
    $(".addWangDian").unbind();
    $(".addWangDian").click(function () {
        window.parent.$(".modelBox24 .moneyErr").text("")
        window.parent.$(".modelBox24").attr("data-id","");
        window.parent.$(".modelBox24 .ErrorMsg").text("")
        window.parent.$(".modelBox24 .name").val("")
        window.parent.$("#sendAddress2").val("")
		window.parent.$(".modelBox24 .contacts").val("")
		window.parent.$(".modelBox24 .ConNumber").val("")
		window.parent.$(".modelBox24 .money").val("")
		window.parent.$(".modelBox24 .bankCard").val("")
        window.parent.$("#province2").attr("data-isselect",0)
        window.parent.$("#city2").attr("data-isselect",0)
        window.parent.$("#area2").attr("data-isselect",0)

        window.parent.$("#fuzeren").attr("data-isselect",0)

        var str='<div class="item clearfix">\n' +
            '                            <div  data-isselect="0" class="selectPub Lf cardList selectCoup" data-selectedindex="-1" style="float: left;background-color: white;margin-top: 7px;">\n' +
            '                                <span>请选择</span>\n' +
            '                                <img src="img/prl-select.jpg" alt="">\n' +
            '                                <ul class="">\n' +
            '                                </ul>\n' +
            '                            </div>\n' +
            '                            <input type="text" placeholder="金额" class="wangDianIpt Lf coupMoney" style="margin-top: 7px;">\n' +
            '                            <div class="Lf addKaQuan" style="margin-top: 14px;">+</div>\n' +
            '                        </div>'
        window.parent.$(".modelBox24 .coupList").html(str)
        //					卡券点击添加
        window.parent.$(".modelBox24 .addKaQuan").unbind();
        window.parent.$(".modelBox24 .addKaQuan").click(function () {
            var str='<div class="item clearfix cardList">\n' +
                '                            <div  data-isselect="0" class="selectPub Lf selectCoup" data-selectedindex="-1" style="float: left;background-color: white;margin-top: 7px;">\n' +
                '                                <span>请选择</span>\n' +
                '                                <img src="img/prl-select.jpg" alt="">\n' +
                '                                <ul class="">\n' +
                '                                </ul>\n' +
                '                            </div>\n' +
                '                            <input type="text" placeholder="金额" class="wangDianIpt Lf coupMoney" style="margin-top: 7px;">\n' +
                '                        </div>'
            $(this).parents(".coupList").append(str)
            getKaQuanList();
        })
        window.parent.$(".coupList").parents(".clearfix").show()
		window.parent.getProvence(2)
        getKaQuanList();
        getFuZeRen();
		window.parent.$(".modelBox24").show()
        window.parent.$("#province2").attr('data-isselect',0);
    })

//	获取卡券列表
    function getKaQuanList() {
        $.ajax({
            url: pubIP + 'order/queryTCouponInfor', /*v1.0*/
            type: 'get',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            cache: false,
            ansyc: true,
            dataType: 'json',
            data:{
                iDisplayStart: 1,
                iDisplayLength: 10000,
            },
            success: function (res) {
                console.log(res)
                if (res.aData.length != 0) {
                    var str='';
                    $.each(res.aData,function (idx,item) {
                        if(item.attr_2==1){
                            window.parent.$(".modelBox24 .money").attr("data-allMoney",item.money);
//                            $("#money").attr("data-dot-id",item.dot_id);
//                            $("#money").attr("data-zijin-id",item.id);
                        }else{
                            str+='<li data-money="'+item.money+'" data-dot-id="'+item.dot_id+'" data-index="'+item.id+'">'+item.coupon_name+'</li>';
                        }
                    })
                    window.parent.$(".modelBox24 .coupList .item").each(function (idx,item) {
						$(item).find("ul").html(str);
                        $(item).find("li").unbind();
                        $(item).find("li").click(function (event) {
                            event.stopPropagation();
                            var that=this;
                            var isOk=0
                            window.parent.$(".coupList .item").each(function (idx1,item1) {
                                if($(item1).find(".selectPub").attr("data-selectedindex")==$(that).attr('data-index')&&$(that).parents(".item").index()!=idx1){
                                    isOk=1;
                                    cf_alert01(2,"不能重复添加卡券")
                                    return;
                                }
                            })
							if(isOk==1){
                                return;
							}
                            $(this).parent().parent().attr('data-selectedindex', $(this).attr('data-index'));
                            $(this).parent().parent().attr('data-money', $(this).attr('data-money'));
                            $(this).parent().parent().attr('data-dot-id', $(this).attr('data-dot-id'));
                            $(this).parent().parent().attr('data-kq-money', $(this).attr('data-kq-money'));
                            $(this).parent().parent().find('span').text($(this).text());
                            $(this).parent().parent().children('img').attr('src', 'img/prl-select.jpg')
                            $(this).parent().css('display','none');
                        })
                    })
                    // 模拟下拉框
                    window.parent.$('.selectCoup').unbind()
                    window.parent.$('.selectCoup').click(function(event){
                        if($(this).attr("disabled")=="disabled"){return;}//不可选
                        if($(this).children('img').attr('src') == 'img/prl-selected.jpg'){
                            $(this).children('img').attr('src', 'img/prl-select.jpg')
                        } else {
                            $(this).children('img').attr('src', 'img/prl-selected.jpg')
                        }

                        event.stopPropagation();

                        $(this).children('ul').toggle();
                        var that = $(this);
                        that.find('li').each(function(){
                            $(this).mouseover(function(){
                                $(this).addClass('hovered')
                            });
                            $(this).mouseleave(function(){
                                $(this).removeClass('hovered')
                            });
                            if($(this).attr('data-index') == that.attr('data-selectedindex')){
                                $(this).css({'background': '#6ea3ff','color': '#fff'});
                                $(this).siblings('li').css({'background': '#fff','color': '#999'});
                            }
                        });

                    }).mouseleave(function (event) {
                        $(this).children('img').attr('src', 'img/prl-select.jpg');
                        $(this).children('ul').hide();
                    });
                }

            },
            error: function(err){
                console.log(err);
            }
        });
    }

    //金额改变  显示
    window.parent.$('.modelBox24 .money').bind('input propertychange',function () {
        if($(this).attr("data-allmoney")-0<$(this).val()-0){
			window.parent.$(".modelBox24 .moneyErr").text("剩余可用资金："+$(this).attr("data-allmoney"))
		}else{
            window.parent.$(".modelBox24 .moneyErr").text("")
		}
	});



    //	获取负责人
    function getFuZeRen() {
        window.parent.$("#fuzeren ul").html("")
        $.ajax({
            url: pubIP + 'carrierDot/getCompanyUser', /*v1.0*/
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            cache: false,
            ansyc: true,
            dataType: 'json',
            data:{

            },
            success: function (res) {
				if(res.code==0){
					var str='';
					$.each(res.data,function (idx,item) {

						if(window.parent.$("#fuzeren").attr("data-isselect")==0){
                            window.parent.$("#fuzeren").attr("data-selectedindex","-1");
                            window.parent.$("#fuzeren span").text("请选择")
						}else if(window.parent.$("#fuzeren").attr("data-isselect")==item.id){
                            window.parent.$("#fuzeren").attr("data-selectedindex",item.id);
                            if(item.name==null || item.name==""){
                                window.parent.$("#fuzeren span").text(item.loginName)
							}else{
                                window.parent.$("#fuzeren span").text(item.name)
							}

						}
						if(item.name==null || item.name==""){
                            str+='<li data-id="'+item.id+'" data-index="'+item.id+'">'+item.loginName+'</li>';
						}else{
                            str+='<li data-id="'+item.id+'" data-index="'+item.id+'">'+item.name+'</li>';
						}

					})
					window.parent.$("#fuzeren ul").html(str)

                    window.parent.$("#fuzeren ul li").unbind();
                    window.parent.$("#fuzeren ul li").click(function(event){
                        event.stopPropagation();
                        $(this).parent().parent().attr('data-selectedindex', $(this).attr('data-index'));
                        $(this).parent().parent().find('span').text($(this).text());
                        $(this).parent().parent().children('img').attr('src', 'img/prl-select.jpg')
                        $(this).parent().css('display','none');
                    });
				}
            },
            error: function(err){
                console.log(err);
            }
        });
    }

    //进入页面加载数据
    getData(1);
    //获取数据
    function getData(currentPage) {
        $(".listBox tbody").html("");
        $.ajax({
            url: pubIP + 'carrierDot/dotList', /*v1.0*/
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            cache: false,
            ansyc: true,
            dataType: 'json',
            data:{
                iDisplayLength:pageSize,
                iDisplayStart:currentPage,
                token:token
            },
            success: function (res) {

                    //首次请求时 改变分页数据
                    if(res.aData.length==0 || res.aData==null ){ $(".listBox tbody").html("");$(".pagination").parent().css("display","none"); return;}
                    $(".pagination").parent().css("display","block");
                    if(currentPage==1){
                        //修改底部分页
                        var pageNum=Math.ceil(res.iTotalRecords/pageSize);
                        $(".allPageN").attr("pageTotal",pageNum);
                        $(".pageJump i").text("共"+pageNum+"页");
                        $('.objListBox>div:nth-child(5n)').css('margin-right','0');
                        Page({
                            num: pageNum,
                            elem: $('#page1'),
                            callback: function(n) {
                                // console.log(n);
                                getData(n);//加载n页数据
                            }
                        });
                    }
                    //修改底部页数
                    $(".allPageN").text((currentPage)+"/"+ $(".allPageN").attr("pageTotal"));
                    cf_dataRender(res.aData)

            },
            error: function(err){
                console.log(err);
            }
        });
    }
    //渲染数据
    function cf_dataRender(data) {
        var str='';
        $.each(data,function (idx,item) {
            str+='<tr data-id="'+item.id+'">';
            str+='<td>'+item.dot_name+'</td>';
            str+='<td>'+item.dot_addr.split("-")[3]+'</td>';
            str+='<td>'+item.dot_contacts+'</td>';
            str+='<td>'+item.dot_ConNumber+'</td>';
            if(item.dot_balance==null){
                str+='<td>0</td>'
			}else{
                str+='<td>'+item.dot_balance+'</td>'
			}

			if(item.attr_1==1 && item.dot_status==0){
                str+='<td>开启</td>'
			}else if(item.attr_1==1 && item.dot_status==1){
                str+='<td>关闭</td>'
            }else if(item.attr_1==0){
                str+='<td>待审批</td>'
            }else if(item.attr_1==2){
                str+='<td>审批拒绝</td>'
            }
            str+='<td><a class="btn seeDetail">查看</a><a class="btn editList">编辑</a><a class="btn delBtn">删除</a>';
				if(item.attr_1==1 && item.dot_status==0){
					str+='<a class="btn guanbi">关闭</a>'
				}else if(item.attr_1==1 && item.dot_status==1){
					str+='<a class="btn kaiqi">开启</a>'
				}
				str+='</td>';
            str+='</tr>';
        })
        $(".listBox tbody").html(str);
        //详情
        $(".seeDetail").unbind();
        $(".seeDetail").click(function () {
                sessionStorage.setItem("detailId",$(this).parents("tr").attr("data-id"));
                window.location.href="./settlementNetwork_detil.html";
        })
//		编辑
        $(".editList").unbind();
        $(".editList").click(function () {
            getInfoById($(this).parents("tr").attr("data-id"));
        })
        //删除
        $(".delBtn").unbind()
        $(".delBtn").click(function () {
           del(this);
        })
        //关闭
        $(".guanbi").unbind();
        $(".guanbi").click(function () {
            upadtaState(1,this);
        })
        //开启
        $(".kaiqi").unbind();
        $(".kaiqi").click(function () {
            upadtaState(0,this);
        })
    }
    //选择排序方式
    $(".select ul li").click(function () {
        getData(1);
    })
    // 点击go刷新数据
    $('.pageCont').on('click', '.button',function(){
        var currentPage1 = $('.pageCont li.active>a').text();
        getData(currentPage1);
    })

//	申请网点  确认按钮
    window.parent.$(".modelBox24 .sure").unbind();
	window.parent.$(".modelBox24 .sure").click(function () {

        if(window.parent.$(".modelBox24 .name").val()==""){
            window.parent.$(".modelBox24 .ErrorMsg").text("请填写网点名称")
	        return;
		}
        if(window.parent.$("#sendAddress2").val()==""){
            window.parent.$(".modelBox24 .ErrorMsg").text("请填写详细地址")
            return;
        }

        if( window.parent.$("#fuzeren").attr("data-selectedindex")=="-1"){
            window.parent.$(".modelBox24 .ErrorMsg").text("请选择负责人")
            return;
        }
        if(window.parent.$(".modelBox24 .contacts").val()==""){
            window.parent.$(".modelBox24 .ErrorMsg").text("请填写联系人")
            return;
        }
        if(window.parent.$(".modelBox24 .ConNumber").val()==""){
            window.parent.$(".modelBox24 .ErrorMsg").text("请填写联系电话")
            return;
        }
        if(window.parent.$(".modelBox24 .money").val()==""){
            window.parent.$(".modelBox24 .ErrorMsg").text("请填初始资金")
            return;
        }
        if(window.parent.$(".modelBox24 .bankCard").val()==""){
            window.parent.$(".modelBox24 .ErrorMsg").text("请填写银行卡")
            return;
        }

        var params=[];
        var quanIsok=1;
        var moneyLess=1;
        window.parent.$(".modelBox24 .coupList .item").each(function (idx1,item1) {
            if($(item1).find(".selectPub").attr("data-selectedindex")==-1){
                return;
            }
            if($(item1).find(".selectPub").attr("data-selectedindex")!=-1 && $(item1).find("input").val()==""){
                quanIsok=0;
                window.parent.$(".modelBox24 .ErrorMsg").text("请填写优惠券金额")
                return;
            }
            if($(item1).find("input").val()-0>$(item1).find(".selectPub").attr("data-money")-0){
                moneyLess=0;
			}
            var obj={}
            obj.couponId=$(item1).find(".selectPub").attr("data-selectedindex");
            obj.applyMoney=$(item1).find("input").val();
            params.push(obj)
        })

        if(quanIsok==0){
            window.parent.$(".modelBox24 .ErrorMsg").text("请填写优惠券金额")
            return;
        }

        if(moneyLess==0){
            window.parent.$(".modelBox24 .ErrorMsg").text("优惠券金额不能大于可使用金额");
            return;
		}
        window.parent.$(".modelBox24 .ErrorMsg").text("")
        if(window.parent.$(".modelBox24 .moneyErr").text()!=""){
            window.parent.$(".modelBox24 .ErrorMsg").text("");
            return;
        }
        $.ajax({
            url: pubIP + "carrierDot/checkCompanyUser", /*v1.0*/
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            cache: false,
            ansyc: true,
            dataType: 'json',
            data:{
                userId:window.parent.$("#fuzeren").attr("data-selectedindex"),
            },
            success: function (res) {
                if(res.code==0){
                    addMetwork(params)
                }else if(res.code==1){
                    window.parent.$(".modelBox24_error").show();
                    window.parent.$(".modelBox24_error .continue").unbind()
                    window.parent.$(".modelBox24_error .continue").click(function () {

                        window.parent.$(".modelBox24_error .innerErrmsg").text(res.msg)
                        $(this).parents(".modelCont").parent().hide();
                        addMetwork(params);
                    })
                }else{
                    cf_alert01(2,res.msg)
				}

            }
        })



    })
	function addMetwork(params){
        var reqUrl="";
//		if(window.parent.$(".modelBox24").attr("data-id")==""){
//            reqUrl="carrierDot/dotApply";
//		}else{
        reqUrl="carrierDot/dotEdite";
//		}

        $.ajax({
            url: pubIP + reqUrl, /*v1.0*/
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            cache: false,
            ansyc: true,
            dataType: 'json',
            data:{
                id:window.parent.$(".modelBox24").attr("data-id"),
                userId:window.parent.$("#fuzeren").attr("data-selectedindex"),
                dot_province:window.parent.$("#province2").attr("data-proviceid"),
                dot_city:window.parent.$("#city2").attr("data-cityid"),
                dot_county:window.parent.$("#area2").attr("data-areaid"),
                dot_name: window.parent.$(".modelBox24 .name").val(),
                dot_addr: window.parent.$("#province2 span").text()+'-'+window.parent.$("#city2 span").text()+'-'+window.parent.$("#area2 span").text()+'-'+window.parent.$("#sendAddress2").val(),
                dot_contacts:window.parent.$(".modelBox24 .contacts").val(),
                dot_ConNumber:window.parent.$(".modelBox24 .ConNumber").val(),
                dot_money:window.parent.$(".modelBox24 .money").val(),
                dot_bankCard:window.parent.$(".modelBox24 .bankCard").val(),
                params:JSON.stringify(params)
            },
            success: function (res) {
                if(res.code==0){
                    cf_alert(1,"编辑网点成功");
                }else{

                }

            }
        })
	}
//用id 做回显upadtaState
	function getInfoById(id) {
        $.ajax({
            url: pubIP + 'carrierDot/getInfoById', /*v1.0*/
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            cache: false,
            ansyc: true,
            dataType: 'json',
            data:{
                id:id
            },
            success: function (res) {
                if(res.code==0){
                    window.parent.$(".modelBox24").attr("data-id",id);
                    window.parent.$(".modelBox24 .ErrorMsg").text("")
                    window.parent.$(".modelBox24 .name").val(res.data.dot_name)
                    window.parent.$("#sendAddress2").val(res.data.dot_addr.split("-")[3])
                    window.parent.$(".modelBox24 .contacts").val(res.data.dot_contacts)
                    window.parent.$(".modelBox24 .ConNumber").val(res.data.dot_ConNumber)
                    window.parent.$(".modelBox24 .money").val(res.data.dot_money)
                    window.parent.$(".modelBox24 .bankCard").val(res.data.dot_bankCard)

                    window.parent.$("#province2").attr("data-isselect",res.data.dot_province)
                    window.parent.$("#city2").attr("data-isselect",res.data.dot_city)
                    window.parent.$("#area2").attr("data-isselect",res.data.dot_county)
                    window.parent.$("#fuzeren").attr("data-isselect",res.data.user_id)

                    window.parent.$(".modelBox24 .coupList").parents(".clearfix").hide()

                    getFuZeRen();
                    window.parent.getProvence(2)
                    window.parent.$(".modelBox24").show()
                }else{

                }

            }
        })
    }

    //开启和关闭
    function upadtaState(state,that) {
        $.ajax({
            url: pubIP + 'carrierDot/dotExamine', /*v1.0*/
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            cache: false,
            ansyc: true,
            dataType: 'json',
            data:{
                dot_id:$(that).parents("tr").attr("data-id"),
                dot_status:state
            },
            success: function (res) {
                if(res.code==0){
					cf_alert(1,state==0?"开启成功":"关闭成功")
                }else{

                }

            }
        })
    }
    function del(that) {
        $.ajax({
            url: pubIP + 'carrierDot/dotDelete', /*v1.0*/
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            cache: false,
            ansyc: true,
            dataType: 'json',
            data:{
                id:$(that).parents("tr").attr("data-id")
            },
            success: function (res) {
                if(res.code==0){
                    cf_alert(1,"删除成功")
                }else{
					cf_alert01(2,res.msg)
                }

            }
        })
    }
</script>
</body>
</html>
