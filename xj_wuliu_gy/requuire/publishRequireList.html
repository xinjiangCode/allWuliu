<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" CONTENT="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta name="format-detection" content="telephone=no" />
    <title>新疆物流服务平台</title>
    <link rel="stylesheet" type="text/css" href="../css/commin.css"/>
    <link rel="stylesheet" href="../css/require_style/publishRequireList.css">
    <style>
        .listBox table{
            border-bottom: 1px solid #ebe9ea;
        }
        .bottomOperiat{
            border-top: 1px solid #ebe9ea;
            border-bottom: 1px solid #ebe9ea;
            height: 60px;
            box-sizing: border-box; 
            font-size: 14px;
        }
        .bottomOperiat>span{
            float: left;
            line-height: 60px;
            cursor: pointer;
        }
        .bottomOperiat .squre{
            border: 1px solid #ebe9ea;
            display: inline-block;
            width: 13px;
            height: 13px;
            margin-left: 20px;
            margin-right: 8px;
            margin-top: 23px;
            border-radius: 3px;
        }
        .bottomOperiat .squre.active{
            background: #6ba1ff;
        }
        .bottomOperiat>.selsectAll{
            margin-right: 20px;
        }
        .bottomOperiat>.closeBtn{
            margin-right: 16px;
        }
        .bottomOperiat>.delBtn, .bottomOperiat>.closeBtn{
            margin-top: 10px;
            width: 112px;
            height: 38px;
            line-height: 38px;
            text-align: center;
            color: #fff;
            background: #6BA1FF;
        }
        .pageBox{
            height: 76px;
            line-height: 76px;
            box-sizing: border-box;
        }

        .modelBox0{
            z-index: 9999;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modelCont{
            position: absolute;
            width: 450px;
            min-height: 276px;
            left: 50%;
            top: 50%;
            /*margin-left: -225px;
            margin-top: -200px;*/
            margin-left: 0 !important;
            margin-top: 0 !important;
            transform: translate(-50%,-50%);-webkit-transform: translate(-50%,-50%);-ms-transform: translate(-50%,-50%);-moz-transform: translate(-50%,-50%);-o-transform: translate(-50%,-50%);
            font-family: 'microsoft yahei';
            /* background-color: red; */

        }
        .modeltitle{
            width: 450px;
            height: 50px;
            background-image: url(../img/gsxq.gif);
            background-size: 100% 100%;
            background-repeat: no-repeat;
            font-size: 16px;
            color: #5690f6;
            line-height: 50px;
        }
        .modelcontent{
            width: 450px;
            background-image: url('../img/gsxq_cont.gif');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="contbox">
        <div class="topTitle">发布需求列表<div class="fr cfRefresh"><img src="../img/prl-refresh.png" alt="" width="27" height="34">刷新</div></div>
        <div class="inputBox">
            <label for="">输入搜索</label><input class="orderNo input" type="text" placeholder="需求编号">
            <label for="">输入搜索</label><input id="goodsName" class=" input" type="text" placeholder="商品名称">
            <!--<label for="">货物类型</label>-->
            <!--<div class="goodsType input select" data-selectedindex="0"><span>全部</span><img src="../img/prl-select.jpg" >-->
                <!--<ul>-->
                    <!--<li data-index="1">类型1</li>-->
                    <!--<li data-index="2">类型2</li>-->
                    <!--<li data-index="3">类型3</li>-->
                <!--</ul>-->
            <!--</div>-->
            <label for="">发布时间</label><input type="text" class="date-input laydate-icon publishTime input" placeholder="请选择日期" id="test1">
            <input class="searchResultBtn btn input" type="button" value="查询结果">
            <input class="advancedRetrievalBtn btn input" onclick="sessionStorage.setItem('isAddRequireMent',1);window.location.href='../personal/addRequireMent.html'" type="button" value="发布需求">
        </div>
        <div class="opciationBox">
            <!--<div class="selectPub displayNum" data-selectedindex="0"><span>显示条数</span><img src="../img/prl-select.jpg" alt="">-->
                <!--<ul>-->
                    <!--<li data-index="1">10</li>-->
                    <!--<li data-index="2">20</li>-->
                    <!--<li data-index="3">30</li>-->
                <!--</ul>-->
            <!--</div>-->
            <input class="exportDemandBtn" type="button" value="导出需求">
        </div>
        <div class="listBox" style="">
            <table>
                <thead>
                    <tr>
                        <td>需求编号</td>
                        <td>发布时间</td>
                        <td>报价公司</td>
                        <td>货物类型</td>
                        <td>货物名称</td>
                        <td>始发地</td>
                        <td>目的地</td>
                        <!--<td>保证金</td>-->
                        <td>倒计时</td>
                        <td>操作</td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>3001804091631062137</td>
                        <td>2017-07-19 14:48</td>
                        <td>危化-罐装</td>
                        <td>氢氧化钠</td>
                        <td>新疆-乌鲁木齐</td>
                        <td>北京-朝阳区</td>
                        <td>1000.00</td>
                        <td>2017-07-19 14:48</td>
                        <td><span class="seeDetail ll">查看</span><span class="edit ll">编辑</span><span class="del">删除</span></td>
                    </tr>
                    <tr>
                        <td>3001804091631062137</td>
                        <td>2017-07-19 14:48</td>
                        <td>危化-罐装</td>
                        <td>氢氧化钠</td>
                        <td>新疆-乌鲁木齐</td>
                        <td>北京-朝阳区</td>
                        <td>1000.00</td>
                        <td>2017-07-19 14:48</td>
                        <td><span class="seeDetail ll">查看</span><span class="edit ll">编辑</span><span class="del">删除</span></td>
                    </tr>
                    <tr>
                        <td>3001804091631062137</td>
                        <td>2017-07-19 14:48</td>
                        <td>危化-罐装</td>
                        <td>氢氧化钠</td>
                        <td>新疆-乌鲁木齐</td>
                        <td>北京-朝阳区</td>
                        <td>1000.00</td>
                        <td>2017-07-19 14:48</td>
                        <td><span class="seeDetail ll">查看</span><span class="edit ll">编辑</span><span class="del">删除</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!--<div class="bottomOperiat">-->
            <!--<span class="squre"></span>-->
            <!--<span class="selsectAll">全选</span>-->
            <!--<span class="closeBtn">关闭订单</span>-->
            <!--<span class="delBtn">删除订单</span>-->
        <!--</div>-->
        <div class="" style="text-align: center;height: 75px;padding-top: 17px;margin-bottom: 0;border-top: 1px solid #ebe9ea;">
            <ul class="pagination" id="page1" style="position: static;margin-bottom: 0;"></ul>
            <div class="pageJump">
                <span class="allPageN">1/200</span>
                <i style="margin-left: 12px;">共200页</i>，
                <span>到第</span>
                <input type="text"/>
                <span>页</span>
                <button type="button" class="button">GO</button>
            </div>
        </div>
        <!--<div class="pageBox">-->
        <!--共100张 当前为1页 共5页-->
        <!--</div>-->
    </div>

    <!--//选择公司-->
    <div class="modelBox0 " style="">
        <div class="modelCont" style="width: 800px;height: 390px;">
            <div class="modeltitle" style="width: 780px;padding-left: 20px;">
                <span>需求信息</span>
                <img class="close" style="float: right;cursor: pointer;" height="50" src="../img/gsxq_del.png" alt="">
            </div>
            <div class="modelcontent"  style="width: 780px;height: 340px;padding-left: 20px;font-size: 16px;padding-top: 20px;">
                <div class="requireInfo infoBox">
                    <!--<div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">需求信息</div>-->
                    <div class="contBox" >
                        <div class="contlist contlistone clearFloat">
                            <div class="Lf " style="width: 250px;">
                                <div>需求编号：<span id="demandNo">201707196369321</span></div>
                                <div>发布时间：<span id="createTime">2015-09-08 23:00</span></div>
                                <!--<div>装车时间：<span>2015-09-08 23:00</span></div>-->
                            </div>
                            <div class="Lf " style="width: 520px;">
                                <div><span style="vertical-align: top;">始&nbsp;&nbsp;发&nbsp;&nbsp;地：</span><span class="sendAddress" style="display: inline-block;width: 400px;">新疆-乌鲁木齐-xxxx区-xxxx路-xxxx号xxx详情</span></div>
                                <div class="desti"><span style="vertical-align: top;">目&nbsp;&nbsp;的&nbsp;&nbsp;地：</span><span  class="destination receiveAddresss" style="display: inline-block;width: 400px;">新疆-乌鲁木齐-xxxx区-xxxx路-xxxx号xxx详情中华人民共和国北京市东城区朝阳花园</span></div>
                            </div>
                        </div>
                        <div class="contlist contlisttwo clearFloat">
                            <div class="Lf " style="width: 252px;">
                                <div>货物类型：<span id="goodsType">危化</span></div>
                                <div>重&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;量：<span id="goodsWeight">150吨</span></div>
                                <!--<div>支付方式：<span>预付</span></div>-->
                                <!--<div>保&nbsp;&nbsp;证&nbsp;&nbsp;金：<span>¥1000.00</span></div>-->
                                <div>结算方式：<span id="paymentMode	">现汇</span></div>
                            </div>
                            <div class="Lf " style="width: 250px;">
                                <div>包装类型：<span id="packageType">罐装</span></div>
                                <div>开&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;票：<span id="invoiceType">普票</span></div>
                                <div style="width: 500px;text-overflow: ellipsis;overflow: hidden;white-space: nowrap;">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：<span id="goodsRemark" style="">备注信息</span></div>
                                <!--<div>缴纳方式：<span>抵扣</span></div>-->
                            </div>
                            <div class="Lf " style="width: 250px;" >
                                <div>货物名称：<span class="goodsName">片碱</span></div>
                                <div>车辆类型：<span id="carType">罐装车</span></div>
                                <!--<div>回&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;单：<span>需要</span></span></div>-->

                            </div>
                        </div>
                    </div>
                </div>
                <div class="baojiaCompany infoBox" style="width: 755px;border: 1px solid #e0e0e0;margin-top: 20px;padding-left: 5px;  ">
                    <!--<div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">报价公司</div>-->
                    <div class="contBox" id="baoJiaompany" style="height: 173px;overflow-y: auto;">
                        <ul class="clearFloat" style="padding: 5px 0;">
                            <li class="Lf " style="width: 292px;">公司名称：<span >化动力有限公司</span></li>
                            <li class="Lf" style="width: 292px;">报&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价：<span >120元/吨</span></li>
                            <li class="Lf "><span class=" btn blue ll">选&nbsp;&nbsp;择</span><span class="del btn" style="margin-left: 20px;">删&nbsp;&nbsp;除</span></li>
                        </ul>
                        <ul class="clearFloat" style="padding: 5px 0;">
                            <li class="Lf " style="width: 292px;">公司名称：<span >化动力有限公司</span></li>
                            <li class="Lf" style="width: 292px;">报&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价：<span >120元/吨</span></li>
                            <li class="Lf "><span class=" btn blue ll">选&nbsp;&nbsp;择</span><span class="del btn" style="margin-left: 20px;">删&nbsp;&nbsp;除</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../js/jquery-3.2.1.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../js/pager.js" type="text/javascript" charset="utf-8"></script>
    <script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
    <script src="../laydate/laydate.js"></script> <!-- 改成你的路径 -->
    <script type="text/javascript">
        //Iframe 的高度
        $(function () {
            window.parent.$("#Iframe").css("height","917");
        })
        //        时间初始化
        var startTime = '';
        var endTime = '';
        laydate({
            elem: '#test1',
            format: 'YYYY-MM-DD',
            istime: true,
            choose: function(dates){ //选择好日期的回调
                startTime = dates;
            }
        });
        laydate({
            elem: '#test2',
            format: 'YYYY-MM-DD',
            istime: true,
            choose: function(dates){ //选择好日期的回调
                endTime = dates;
            }
        });
        laydate.skin('yahui');  //加载皮肤，参数lib为皮肤名


        $('.objListBox>div:nth-child(5n)').css('margin-right','0');
        Page({
            num: 200,
            elem: $('#page1'),
            callback: function(n) {
                console.log(n);
            }
        });
        //查看详情
        $(".seeDetail").click(function () {
            window.location.href="./publishRequireList-detail.html";
        })
//        从首页点过来时自动到发布需求
        if(sessionStorage.getItem("isAdd")==1){
            sessionStorage.setItem("isAdd",0);
            window.location.href="../personal/addRequireMent.html";
        }
        //搜索按钮
        $(".searchResultBtn").click(function () {
            getData(1);
        })

        var currentPageAll=1;
        //进入页面加载数据
        getData(1);
        //获取数据
        function getData(currentPage) {
            $(".listBox tbody").html("");//所有条件查询列表 必须先置空
            $.ajax({
                url: pubIP + 'wlLogisticsDemand/queryPageForRelease', /*v1.0*/
                type: 'get',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                cache: false,
                ansyc: true,
                dataType: 'json',
                data:{
                    companyId:companyId,
                    pageSize:pageSize,
                    demandNo:$("input.orderNo.input").val(),
                    startDate:$(".startDate").val(),
                    pageIdx:currentPage,
                    goodsName:$("#goodsName").val()
                },
                success: function (res) {
                    if(res.code===1){
                        //首次请求时 改变分页数据
                        if(res.data.data.length==0){ $(".listBox tbody").html("");$(".pagination").parent().css("display","none"); return;}
                        $(".pagination").parent().css("display","block");
                        if(currentPage===1){
                            //修改底部分页
                            //debugger
                            var pageNum=Math.ceil(res.data.total/pageSize);
                            $(".allPageN").attr("pageTotal",pageNum);
                            $(".pageJump i").text("共"+pageNum+"页");
                            $('.objListBox>div:nth-child(5n)').css('margin-right','0');
                            Page({
                                num: pageNum,
                                elem: $('#page1'),
                                callback: function(n) {
                                    // console.log(n);
                                    currentPageAll=n;
                                    getData(n);//加载n页数据
                                }
                            });
                        }
                        //修改底部页数
                        $(".allPageN").text((currentPage)+"/"+ $(".allPageN").attr("pageTotal"));
                        cf_dataRender(res.data.data)
                    }else{
                        alert(res.msg);
                    }
                },
                error: function(err){
                    console.log(err);
                }
            });
        }
        //渲染数据
        function cf_dataRender(data) {
            var str='';
            $.each(data,function (idx,item) {
                str+='<tr data-id="'+item.id+'"  data-demandNo="'+item.demandNo+'">';
                str+="<td>"+item.demandNo+"</td>"
                str+="<td>"+timestampToTime(item.createTime)+"</td>"
                str+="<td>"+item.var9+"</td>"
                str+="<td>"+item.goodsType+"</td>"
                str+="<td>"+item.goodsName+"</td>"
                str+="<td>"+item.sendProvince+"-"+item.sendCity+"</td>"
                str+="<td>"+item.receiveProvince+"-"+item.receiveCity+"</td>"
                str+="<td>倒计时</td>"
                str+="<td><span class=\"seeDetail ll\">查看详情</span><span class='ll editThis'>编辑</span><span class='ll deletThis'>删除</span></td>"
//                    <span class="selectCompany ll">选择公司</span>
                str+='</tr>';
            })
            $(".listBox tbody").html(str);
            //模拟点击 框
            $(".listBox .cf_select").click(function () {
                $(this).toggleClass("on");
            })
            //详情
            $(".seeDetail").click(function () {
                sessionStorage.setItem("detailId",$(this).parents("tr").attr("data-id"));
                window.location.href="./toConfirmRequire-detail.html";
            })
            //选择公司
            $(".selectCompany").click(function () {
                sessionStorage.setItem("detailId",$(this).parents("tr").attr("data-id"));
                getDataCompanyList()
                getDataSelect()
                $(".modelBox0").show();

            })
            //编辑
            $(".editThis").click(function () {
                sessionStorage.setItem("detailId",$(this).parents("tr").attr("data-id"));
                sessionStorage.setItem("demandNo",$(this).parents("tr").attr("data-demandNo"));
                sessionStorage.setItem("isRequireMent",1);
                sessionStorage.setItem("isAddRequireMent",0);
                window.location.href="../personal/addRequireMent.html";
            })
            //删除
            $(".deletThis").click(function () {
                $.ajax({
                    url: pubIP + 'wlLogisticsDemand/delete', /*v1.0*/
                    type: 'get',
                    headers: {
                        Accept: "application/json; charset=utf-8",
                        token: token
                    },
                    cache: false,
                    ansyc: true,
                    dataType: 'json',
                    data:{
                        id:$(this).parents("tr").attr("data-id")
                    },
                    success: function (res) {
                        if(res.code===1){
                            alert("删除成功")
                            getData(currentPageAll);
                        }else{
                            alert(res.msg);
                        }
                    },
                    error: function(err){
                        console.log(err);
                    }
                });
            })
        }
        //选择排序方式
        $(".select ul li").click(function () {
            currentPageAll=1;
            getData(1);
        })
        // 点击go刷新数据
        $('.pageCont').on('click', '.button',function(){
            var currentPage1 = $('.pageCont li.active>a').text();
            currentPageAll=currentPage1;
            getData(currentPageAll);
        })



        ////////////////////////////////选择公司弹框
        //选择公司  弹框 关闭
        $("img.close").click(function () {
            $(this).parents(".modelCont").parent().hide();
        })
        //获取选择公司弹框数据
        function getDataSelect() {
            $.ajax({
                url: pubIP + 'wlLogisticsDemand/query', /*v1.0*/
                type: 'get',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                cache: false,
                ansyc: true,
                dataType: 'json',
                data:{
                    id:sessionStorage.getItem("detailId")
                },
                success: function (res) {
                    if(res.code===1){
                        cf_dataRenderSelect(res.data)
                    }else{
                        alert(res.msg);
                    }
                },
                error: function(err){
                    console.log(err);
                }
            });
        }

        //渲染选择公司弹框数据
        function cf_dataRenderSelect(data) {
            $("#demandNo").text(data.demandNo);
            $("#createTime").text(data.createTime);
            $(".sendAddress").eq(0).text(data.sendProvince+"-"+data.sendCity+"-"+data.sendArea+"-"+data.sendAddress);
            $(".sendAddress").eq(1).text(data.sendProvince+"-"+data.sendCity+"-"+data.sendArea+"-"+data.sendAddress);
            $(".receiveAddresss").eq(0).text(data.receiveProvince+"-"+data.receiveCity+"-"+data.receiveArea+"-"+data.receiveAddress);
            $(".receiveAddresss").eq(1).text(data.receiveProvince+"-"+data.receiveCity+"-"+data.receiveArea+"-"+data.receiveAddress);
            $("#goodsType").text(data.goodsType);
            if(data.goodsUnit=="重量/吨"){
                $("#goodsWeight").text(data.goodsNum+'吨');
            }else{
                $("#goodsWeight").text(data.goodsNum+'m³');
            }
            $("#packageType").text(data.packageType);
            $("#invoiceType").text(data.invoiceType);
            $("#paymentMode").text(data.paymentMode);
            $(".goodsName").eq(0).text(data.goodsName);
            $(".goodsName").eq(1).text(data.goodsName);
            $("#carType").text(data.carType);
            $("#goodsRemark").text(data.goodsRemark);
            $("#sendUser").text(data.sendUser);
            $("#sendPhone").text(data.sendPhone );
            $("#sendCompanyname").text(data.sendCompanyname);
            $("#receiveUser").text(data.receiveUser);
            $("#receivePhone").text(data.receivePhone);
            $("#receiveCompanyname").text(data.receiveCompanyname);
        }

        //获取报价公司列表
        function getDataCompanyList() {
            $("#baoJiaompany").html("");
            $.ajax({
                url: pubIP + 'wlDemandQuoted/queryList', /*v1.0*/
                type: 'get',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                cache: false,
                ansyc: true,
                dataType: 'json',
                data:{
                    demandid:sessionStorage.getItem("detailId")
                },
                success: function (res) {
                    if(res.code===1){
                        var  str="";
                        $.each(res.data.data,function (idx,item) {
                            str+='<ul class="clearFloat" style="padding: 5px 0;"  data-id='+item.id+'>';
                            str+='<li class="Lf" style="width: 292px;">公司名称：<span >'+item.companyname+'</span></li>';
                            str+='<li class="Lf" style="width: 292px;">报&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价：<span id="unitPrice">'+item.quotedPrice+'元/吨</span></li>'
                            str+='<li class="Lf" data-id="'+item.demandid+'" data-demandid="'+item.demandid+'" data-companyid="'+item.companyid+'"><span class=" btn blue sel" style="color: #6ea3f4;">选&nbsp;&nbsp;择</span><span class="del btn" style="margin-left: 20px;">删&nbsp;&nbsp;除</span></li>'
                            str+="</ul>"
                        })
                        $("#baoJiaompany").html(str);
                        //选择公司
                        $(".sel").click(function () {
                            var demandid= $(this).parent().attr("data-demandid")
                            var companyid=$(this).parent().attr("data-companyid")
                            $.ajax({
                                url: pubIP + 'wlDemandQuoted/updateForChooseCompany', /*v1.0*/
                                type: 'post',
                                headers: {
                                    Accept: "application/json; charset=utf-8",
                                    token: token
                                },
                                cache: false,
                                ansyc: true,
                                dataType: 'json',
                                data:{
                                    demandid:demandid,
                                    companyid:companyid,
                                },
                                success: function (res) {
                                    if(res.code==1){
                                        alert("选择公司成功");
                                        window.location.reload()
                                    }else{
                                        alert(res.msg);
                                    }

                                },
                                error: function(err){
                                    console.log(err);
                                }
                            });
                        })
                        //删除公司
                        $(".del").click(function () {
                            var id= $(this).parent().attr("data-id")
                            $.ajax({
                                url: pubIP + 'wlDemandQuoted/updateForRejectCompany', /*v1.0*/
                                type: 'post',
                                headers: {
                                    Accept: "application/json; charset=utf-8",
                                    token: token
                                },
                                cache: false,
                                ansyc: true,
                                dataType: 'json',
                                data:{
                                    id:id,
                                },
                                success: function (res) {
                                    if(res.code==1){
                                        alert("删除公司成功");
                                        location.reload();
                                    }else{
                                        alert(res.msg);
                                    }

                                },
                                error: function(err){
                                    console.log(err);
                                }
                            });
                        })
                    }else{
                        alert(res.msg);
                    }
                },
                error: function(err){
                    console.log(err);
                }
            });
        }
    </script>
</body>
</html>