<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" CONTENT="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta name="format-detection" content="telephone=no" />
    <title>新疆物流服务平台</title>
    <link rel="stylesheet" type="text/css" href="../css/swiper.min.css"/>
    <link rel="stylesheet" type="text/css" href="../css/commin.css"/>
    <link rel="stylesheet" href="../css/setUp_addpersonnel.css">
    <style>
        .ts {
            display: none;
            font-size: 12px;
            color: red;
            line-height: 38px;
        }

        .boxContent .ctnsItem {
            width: 530px;
        }

        .boxContent .ctnsItem input, .boxContent .ctnsItem textarea {
            float: left;
        }

        .headRight {
            cursor: pointer;
        }
    </style>
</head>
<body>
<!--添加员工-->
<!--<script src="../js/header.js" type="text/javascript" charset="utf-8"></script>-->
<!--<div class="mianCont" style="margin-top: 10px;padding-bottom:24px;">-->
    <!--设置-->
    <!--<div class="manageList Lf cfidx6">-->
        <!--<ul>-->
            <!--<li>-->
                <!--<a href="##" class="manage"><strong>设置</strong> <div style="float: right;vertical-align: middle;margin-right: 15px;"><img src="../img/cf_open.png" alt=""></div></a>-->
                <!--<ul>-->
                    <!--<li><a href="##" class="manageItem" data-src="./accountOverView.html" data-height="1600">贸易合同</a></li>-->
                    <!--<li><a href="##" class="manageItem " data-src="./companyRenzheng/promptCompanyRenzheng.html" data-height="1600">部门管理</a></li>-->
                    <!--<li><a href="##" class="manageItem" data-src="./companyRenzheng/myCollect.html" data-height="1600">角色管理</a></li>-->
                    <!--<li><a href="##" class="manageItem" data-src="./companyRenzheng/accountManage.html" data-height="1600">员工管理</a></li>-->
                    <!--<li><a href="##" class="manageItem" data-src="./accountOverView.html" data-height="1600">自动推送设置</a></li>-->
                    <!--<li><a href="##" class="manageItem " data-src="./companyRenzheng/promptCompanyRenzheng.html" data-height="1600">日志管理</a></li>-->
                    <!--<li><a href="##" class="manageItem" data-src="./companyRenzheng/myCollect.html" data-height="1600">消息管理</a></li>-->
                    <!--<li><a href="##" class="manageItem" data-src="./companyRenzheng/accountManage.html" data-height="1600">常用功能设置</a></li>-->
                <!--</ul>-->
            <!--</li>-->

        <!--</ul>-->
    <!--</div>-->
    <div class="rightContBox"  style="float: none">
        <!--头部-->
        <div class="boxHead">
            <div class="headLeft">添加成员</div>
            <div class="headRight">
                <img src="../img/yh_backHead.png"/>
                <span class="back_btn">返回</span>
            </div>
        </div>
        <!--内容-->
        <div class="boxContent">
            <div class="ctnsItem">
                <span><em>*</em>成员手机号：</span>
                <input type="" name="" class="user_phone" id="" value="" maxlength="11" />
                <div class="ts"></div>
            </div>

            <div class="ctnsItem clearfix">
                <span class="fl"><em>*</em>用户名：</span>
                <input type="" name="" class="username" id="" value="" />
                <div class="ts"></div>
            </div>


            <div class="ctnsItem">
                <span><em>*</em>姓名：</span>
                <input type="" name="" class="name" id="" value="" />
                <div class="ts"></div>
            </div>
            <div class="ctnsItem">
                <span><em>*</em>邮箱：</span>
                <input type="" name="" id="" class="email" value="" />
                <div class="ts"></div>
            </div>
            
            <!-- <div class="ctnsItem">
                <span><em>*</em>登录账号：</span>
                <input type="" name="" id="" value="" />
            </div> -->
            <div class="ctnsItem">
                <span><em>*</em>所属部门：</span>
                <div class="select fl suoshu_department" data-selectedindex="0" style="margin-top: 0px; width: 262px; margin-right: 0px; height: 40px; border: 1px solid #e7e7e7; float: left;">
                    <span style='text-align: left;'>请选择</span>
                    <img src="../img/prl-select.jpg" alt="">
                    <ul class="suoshu_department_ul">
                        <!-- <li data-index="1">10</li>
                        <li data-index="2">20</li>
                        <li data-index="3">30</li> -->
                    </ul>
                </div>
                <div class="ts"></div>
            </div>

            <div class="ctnsItem">
                <span><em>*</em>所属角色：</span>
                <div class="select fl suoshu_role" data-selectedindex="0" style="margin-top: 0px; width: 262px; margin-right: 0px; height: 40px; border: 1px solid #e7e7e7; float: left;">
                    <span style='text-align: left;'>请选择</span>
                    <img src="../img/prl-select.jpg" alt="">
                    <ul class="suoshu_role_ul">
                        <!-- <li data-index="1">10</li>
                        <li data-index="2">20</li>
                        <li data-index="3">30</li> -->
                    </ul>
                </div>
                <div class="ts"></div>
            </div>
            
            <!-- <div class="ctnsItem">
                <span><em>*</em>登录密码：</span>
                <input type="" name="" id="" value="" />
            </div>
            <div class="ctnsItem">
                <span><em>*</em>确认密码：</span>
                <input type="" name="" id="" value="" />
            </div>
            <div class="ctnsItem">
                <span>新支付密码：</span>
                <input type="" name="" id="" value="" />
            </div>
            <div class="ctnsItem">
                <span>支付密码确认：</span>
                <input type="" name="" id="" value="" />
            </div>
            <div class="ctnsItem">
                <span>财务绑定手机验证码：</span>
                <input id="getcode" type="" name="" id="" value="" />
                <span id="codebtn">获取验证码</span>
            </div> -->
            <div class="ctnsItem">
                <span>备注信息：</span>
                <textarea name="" rows="" cols="" style="margin-left: 5px; width: 248px;" placeholder="请输入内容"></textarea>
            </div>
            
            
            <div class="submitbtns">提交</div>
            
            
        </div>
    </div>
<!--</div>-->

<!--<script src="../js/footer.js" type="text/javascript" charset="utf-8"></script>-->
<script src="../js/jquery-3.2.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/swiper.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/common.js?v=201811151239" type="text/javascript" charset="utf-8"></script>


<script type="text/javascript" >
    //Iframe 的高度
    $(function () {
        window.parent.$("#Iframe").css("height","914");
    })
//    //    手机号
//    $('.user_phone').bind('input propertychange',function () {
//        $(".username").val()
//        $(".name").val()
//        $(".email").val()
//        if($(this).val()<10000000000){
//            return;
//        }
//        $.ajax({
//            url: pubIP + 'tReceptionDepartmentPersion/getQueryPersionInfo',
//            type: 'get',
//            headers: {
//                Accept: "application/json; charset=utf-8",
//                token: token
//            },
//            data:{
//                mobile:$(this).val()
//            },
//            cache: false,
//            dataType: 'json',
//            success: function (json) {
//                if (json.code == 1) {
//                    $(".username").val(json.data[0].loginName)
//                    $(".name").val(json.data[0].name)
//                    $(".email").val(json.data[0].email)
//
//                }
//            },
//            error: function(err) {
//                console.log(err);
//            }
//        });
//    });
    //返回
    // 判断用户是否注册过账号
    $('.user_phone').change(function() {

        var username = $(this).val();

        $.ajax({
            url: pubIP + 'tReceptionDepartmentPersion/getQueryPersion',
            type: 'get',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                username: username
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);
                if (json.code == 1) {
                    $('.user_phone').val(json.data.mobile);
                    $('.user_phone').attr('disabled', true);
                } else if (json.code == 0) {
                    cf_alert(2, json.msg);
                }
            },
            error: function(err) {
                console.log(err);
            }
        });
    });

    $('.back_btn').click(function() {
        window.location.href = "setUp_staffManage.html";
    });

    var person_id = window.sessionStorage.getItem('person_id');
    if (person_id != '') {

        $('.headLeft').text('修改成员');
        
        $.ajax({
            url: pubIP + 'tReceptionDepartmentPersion/getDepartmentPersionById',
            type: 'get',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                id: person_id
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);
                if (json.code == 1) {
                    
                    $('.username').val(json.data.username);
                    $('.user_phone').val(json.data.tel);
                    $('.user_phone').attr('disabled', true);

                    $('.name').val(json.data.name);                    
                    $('.email').val(json.data.email);                    

                    $('.suoshu_department span').text(json.data.departmentName);
                    $('.suoshu_department').attr('data-selectedindex', json.data.departmentId);

                    $('.suoshu_role span').text(json.data.roleName);
                    $('.suoshu_role').attr('data-selectedindex', json.data.roleId);

                    $('textarea').val(json.data.remark);



                }
            },
            error: function(err) {
                console.log(err);
            }
        });
    } else {
        $('.username').val('');
        $('.user_phone').val('');

        $('.name').val('');                    
        $('.email').val('');  

        $('.suoshu_department span').text('请选择');
        $('.suoshu_department').attr('data-selectedindex', '-1');

        $('.suoshu_role span').text('请选择');
        $('.suoshu_role').attr('data-selectedindex', '-1');

        $('textarea').val('');
    }

    // 判断用户是否注册过账号
    $('.username').change(function() {

        var username = $(this).val();

        $.ajax({
            url: pubIP + 'tReceptionDepartmentPersion/getQueryPersion',
            type: 'get',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                username: username
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);
                if (json.code == 1) {
                    $('.user_phone').val(json.data.mobile);
                    $('.user_phone').attr('disabled', true);
                } else if (json.code == 0) {
                    cf_alert(2, json.msg);
                }
            },
            error: function(err) {
                console.log(err);
            }
        });
    });

    $('.username').blur(function() {
        if ($(this).val() != '') {
            $(this).parent().find('.ts').css('display', 'none');
        } else {
            $(this).parent().find('.ts').css('display', 'inline-block').text('用户名不能为空');
        }
        
    });

    $('.user_phone').blur(function() {
        if ($(this).val() != '') {
            $(this).parent().find('.ts').css('display', 'none');
        } else {
            $(this).parent().find('.ts').css('display', 'inline-block').text('手机号不能为空');
        }
        
    });

    $('.name').blur(function() {
        if ($(this).val() != '') {
            $(this).parent().find('.ts').css('display', 'none');
        } else {
            $(this).parent().find('.ts').css('display', 'inline-block').text('姓名不能为空');
        }
        
    });

    $('.email').blur(function () {
        if (!(/^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/.test($(this).val()))) {
            $(this).parent().find('.ts').css('display', 'inline-block').text('邮件格式不正确');
            return;
        } else {
            $(this).parent().find('.ts').css('display', 'none');
        }
    });


    //提交
    $('.submitbtns').click(function() {

        var username = $('.username').val();
        var phone = $('.user_phone').val();

        var name = $('.name').val();
        var email = $('.email').val();

        var suoshu_department = $('.suoshu_department span').text();
        var suoshu_department_id = $('.suoshu_department').attr('data-selectedindex');

        var suoshu_role = $('.suoshu_role span').text();
        var suoshu_role_id = $('.suoshu_role').attr('data-selectedindex');

        var beizhu = $('textarea').val();

        if (username == '') {
            $('.username').parent().find('.ts').css('display', 'inline-block').text('用户名不能为空');
            return;
        }

        if (phone == '') {
            $('.user_phone').parent().find('.ts').css('display', 'inline-block').text('手机号不能为空');
            return;
        } 

        if (name == '') {
            $('.name').parent().find('.ts').css('display', 'inline-block').text('姓名不能为空');
            return;
        }

        if (!(/^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/.test($('.email').val()))) {
            $('.email').parent().find('.ts').css('display', 'inline-block').text('邮箱格式不正确');
            return;
        }

        if (suoshu_department == '请选择') {
            $('.suoshu_department').parent().find('.ts').css('display', 'inline-block').text('请选择部门');
            return;
        } 

        if (suoshu_role == '请选择') {
            $('.suoshu_role').parent().find('.ts').css('display', 'inline-block').text('请选择角色');
            return;
        }  

        if (person_id == '') {
            $.ajax({
                url: pubIP + 'tReceptionDepartmentPersion/addDepartmentPersion',
                type: 'post',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    username: username,
                    name: name,
                    email: email,
                    roleId: suoshu_role_id,
                    roleName: suoshu_role,
                    departmentId: suoshu_department_id,
                    departmentName: suoshu_department,
                    remark: beizhu,
                    tel: phone
                },
                cache: false,
                dataType: 'json',
                success: function (json) {
                    console.log(json);
                    if (json.code == 1) {
                        cf_alert(1, '添加成功！');
                    }
                },
                error: function(err) {
                    console.log(err);
                }
            });
        } else {
            $.ajax({
                url: pubIP + 'tReceptionDepartmentPersion/updateWLDepartmentPersion',
                type: 'post',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    username: username,
                    name: name,
                    email: email,
                    roleId: suoshu_role_id,
                    roleName: suoshu_role,
                    departmentId: suoshu_department_id,
                    departmentName: suoshu_department,
                    remark: beizhu,
                    tel: phone,
                    id: person_id
                },
                cache: false,
                dataType: 'json',
                success: function (json) {
                    console.log(json);
                    if (json.code == 1) {
                        cf_alert(1, '修改成功！');
                    }
                },
                error: function(err) {
                    console.log(err);
                }
            });
        }
        
    });

    $(window.parent.document).on('click', '.all_success_alert .modelbtn', function(){
        window.location.href = "setUp/setUp_staffManage.html";
    });


    // 查询所属部门
    // 
    $.ajax({
        url: pubIP + 'receptionDepartment/querySelectList',
        type: 'get',
        headers: {
            Accept: "application/json; charset=utf-8",
            token: token
        },
        cache: false,
        dataType: 'json',
        success: function (json) {
            console.log(json);
            $('.suoshu_department_ul').html("");

            if (json.code == 1) {
                if (json.data.length != 0) {
                    var str = '<li data-departmentId="">请选择</li>';
                    for (var i = 0; i < json.data.length; i++) {
                        str += '<li data-departmentId="'+json.data[i].key+'">'+json.data[i].value+'</li>'
                    }

                    $('.suoshu_department_ul').html(str);

                    $('.select ul li').click(function(){
                        event.stopPropagation();
                        $(this).parent().parent().attr('data-selectedindex', $(this).attr('data-departmentId'));
                        $(this).parent().parent().find('span').text($(this).text());
                        $(this).parent().parent().children('img').attr('src', 'img/prl-select.jpg')
                        $(this).parent().css('display','none');

                        $(this).parent().parent().parent().find('.ts').css('display', 'none');
                            
                        // if ($(this).parent().parent().find('span').text() == '请选择') {
                        //     $(this).parent().parent().parent().find('.ts').css('display', 'block');
                        //     return;
                        // }

                        select_role($(this).attr('data-departmentId'));
                    });
                }
            }
        },
        error: function(err) {
            console.log(err);
        }
    });

    //查询所属角色
    function select_role(role_id) {
        $.ajax({
            url: pubIP + 'tReceptionRole/getSelectRoleList',
            type: 'get',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                departmentId: role_id
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);
                if (json.code == 1) {
                    if (json.data.length != 0) {
                        var str = '<li data-departmentId="">请选择</li>';;
                        for (var i = 0; i < json.data.length; i++) {
                            str += '<li data-departmentId="'+json.data[i].key+'">'+json.data[i].value+'</li>'
                        }

                        $('.suoshu_role_ul').html(str);

                        $('.select ul li').click(function(){
                            event.stopPropagation();
                            $(this).parent().parent().attr('data-selectedindex', $(this).attr('data-departmentId'));
                            $(this).parent().parent().find('span').text($(this).text());
                            $(this).parent().parent().children('img').attr('src', 'img/prl-select.jpg')
                            $(this).parent().css('display','none');

                            $(this).parent().parent().parent().find('.ts').css('display', 'none');
                            
                            // if ($(this).parent().parent().find('span').text() == '请选择') {
                            //     $(this).parent().parent().parent().find('.ts').css('display', 'block');
                            //     return;
                            // }
                            

                        });
                    }
                }
            },
            error: function(err) {
                console.log(err);
            }
        });
    }
</script>
</body>
</html>
