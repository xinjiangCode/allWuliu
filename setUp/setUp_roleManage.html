<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" CONTENT="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta name="format-detection" content="telephone=no" />
    <title>新疆物流服务平台</title>
    <link rel="stylesheet" type="text/css" href="../css/swiper.min.css"/>
    <link rel="stylesheet" type="text/css" href="../css/commin.css"/>
    <link rel="stylesheet" href="../css/setUp_roleManage.css">
	<style>
		.btn{color: #6ba1ff;margin-right: 10px;}
	</style>
</head>
<body>
<!--角色管理-->
<!--<script src="../js/header.js" type="text/javascript" charset="utf-8"></script>-->
<!--<div class="mianCont" style="margin-top: 10px;padding-bottom:24px;">-->
    <!--&lt;!&ndash;设置&ndash;&gt;-->
    <!--<div class="manageList Lf cfidx6">-->
        <!--<ul>-->
            <!--<li>-->
                <!--<a href="##" class="manage"><strong>设置</strong> <div style="float: right;vertical-align: middle;margin-right: 15px;"><img src="../img/cf_open.png" alt=""></div></a>-->
                <!--<ul>-->
                    <!--<li><a href="##" class="manageItem" data-src="./accountOverView.html" data-height="1600">贸易合同</a></li>-->
                    <!--<li><a href="##" class="manageItem " data-src="./companyRenzheng/promptCompanyRenzheng.html" data-height="1600">部门管理</a></li>-->
                    <!--<li><a href="##" class="manageItem" data-src="./companyRenzheng/myCollect.html" data-height="1600">角色管理</a></li>-->
                    <!--<li><a href="##" class="manageItem" data-src="./companyRenzheng/accountManage.html" data-height="1600">员工管理</a></li>-->
                    <!--<li><a href="##" class="manageItem" data-src="./accountOverView.html" data-height="1600">自动推送设置</a></li>-->
                    <!--<li><a href="##" class="manageItem " data-src="./companyRenzheng/promptCompanyRenzheng.html" data-height="1600">日志管理</a></li>-->
                    <!--<li><a href="##" class="manageItem" data-src="./companyRenzheng/myCollect.html" data-height="1600">消息管理</a></li>-->
                    <!--<li><a href="##" class="manageItem" data-src="./companyRenzheng/accountManage.html" data-height="1600">常用功能设置</a></li>-->
                <!--</ul>-->
            <!--</li>-->

        <!--</ul>-->
    <!--</div>-->
    <div class="rightContBox"  style="float: none">
    	<!--头部-->
    	<div class="boxHead">
    		<div class="headLeft">角色管理</div>
    		<!--<div class="headRight cfRefresh">-->
    			<!--<img src="../img/yh_refresh2.png"/>-->
    			<!--<span>刷新</span>-->
    		<!--</div>-->
    	</div>
    	<div class="record">
    		<div></div>
    		<div class="select displayNum sort_method" data-selectedindex="0"><span>排序方式</span><img src="../img/prl-select.jpg" alt="">
				<ul style="top:34px;">
					<li data-index="1">创建时间顺序</li>
					<li data-index="2">创建时间倒序</li>
				</ul>
			</div>
			<div class="select displayNum" data-selectedindex="0"><span>显示条数</span><img src="../img/prl-select.jpg" alt="">
				<ul>
					<li data-index="1">10</li>
					<li data-index="2">20</li>
					<li data-index="3">30</li>
				</ul>
			</div>
    		<!-- <div>排序方式<img src="../img/cf_open.png"/></div>
    		<div>显示条数<img src="../img/cf_open.png"/></div> -->
    		<div class="add_apartment">添加</div>
    	</div>
		<div class="listBox">
			<table class="contentslist">
				<thead>
				<tr>
					<th>角色名称</th>
					<th>所属部门</th>
					<th>职能描述</th>
					<th>成员数量</th>
					<th>添加时间</th>
					<th>是否启用</th>
					<th>操作</th>
				</tr>
				</thead>
				<tbody id="apartmentListInfo">
					<!-- <tr>
						<td>销售部</td>
						<td>暂无描述</td>
						<td>10</td>
						<td>10</td>
						<td> 2017-09-23 10：30：23 </td>
						<td class="chooseswitch">
							<input id="checked_1" type="checkbox" class="switch" />
							<label for="checked_1"></label>
						</td>
						<td style="color: #6ba1ff;">
							<a href="" class="" style="margin-right: 10px;">编辑</a>
							<a href="" class="" style="margin-right: 10px;">权限设置</a>
							<a href="" class="">删除</a>
						</td>
					</tr>
					<tr>
						<td>销售部</td>
						<td>暂无描述</td>
						<td>10</td>
						<td>10</td>
						<td> 2017-09-23 10：30：23 </td>
						<td class="chooseswitch">
							<input id="checked_2" type="checkbox" class="switch" />
							<label for="checked_2"></label>
						</td>
						<td style="color: #6ba1ff;">
							<a href="" class="" style="margin-right: 10px;">编辑</a>
							<a href="" class="" style="margin-right: 10px;">权限设置</a>
							<a href="" class="">删除</a>
						</td>
					</tr> -->

				</tbody>
			</table>
		</div>
		<div class="" style="text-align: center;height: 75px;padding-top: 18px; box-sizing: border-box; margin-bottom: 0;border-top: 1px solid #ebe9ea;">
			<ul class="pagination" id="page1" style="position: static;margin-bottom: 0;"></ul>
			<div class="pageJump">
				<span class="allPageN">1/1</span>
				<i style="margin-left: 12px;">共<span class="total">1</span></i>，
				<span>到第</span>
				<input type="text" style="text-align: center; text-indent: 0px;" />
				<span>页</span>
				<button type="button" class="button">GO</button>
			</div>
		</div>
    </div>
<!--</div>-->

<!--<script src="../js/footer.js" type="text/javascript" charset="utf-8"></script>-->
<script src="../js/jquery-3.2.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/swiper.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/common.js?v=201811151239" type="text/javascript" charset="utf-8"></script>
<script src="../js/pager.js" type="text/javascript" charset="utf-8"></script>


<script type="text/javascript" >
    //Iframe 的高度
    $(function () {
        window.parent.$("#Iframe").css("height","853");
    })
    $('.objListBox>div:nth-child(5n)').css('margin-right','0');
    // Page({
    //     num: 200,
    //     elem: $('#page1'),
    //     callback: function(n) {
    //         console.log(n);
    //     }
    // });

    var isFirst = true;

    var isSearch = 0;

    apartment_list(1, 10);

    // 角色列表
    function apartment_list(num, size) {
        $('#apartmentListInfo').html('');
        $.ajax({
            url: pubIP + 'tReceptionRole/getTReceptionRoleList',
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                page: num,
                size: size,
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);

                if (json.code == 1) {
                    if (json.data.length != 0) {
                    	var str = '';
                        for (var i = 0; i < json.data.length; i++) {
                        
                            json.data[i].createTime = new Date(json.data[i].createTime).Format("yyyy-MM-dd");

                            str += '<tr data-id="'+json.data[i].id+'">'
                            	+'<td class="roleName_td">'+json.data[i].roleName+'</td>'
								+'<td class="ord_name" data-bumen="'+json.data[i].departmentId+'">'+json.data[i].departmentName+'</td>'

								if (json.data[i].roleDescribe != '') {
									str += '<td class="describe">'+json.data[i].roleDescribe+'</td>'
								} else {
									str += '<td class="describe">暂无数据</td>'
								}

								str += '<td>'+json.data[i].counts+'</td>' 
								+'<td>'+json.data[i].createTime+'</td>'
								+'<td class="chooseswitch">'
								if (json.data[i].status == '0') {
									str += '<input id="checked_'+i+'" type="checkbox" class="switch" checked=""/>'
									+'<label for="checked_'+i+'"></label>'
								} else if (json.data[i].status == '1') {
									str += '<input id="checked_'+i+'" type="checkbox" class="switch" />'
									+'<label for="checked_'+i+'"></label>'
								}

								str += '</td>'
                            if(AuthSwitch==0){
                                str +='<td><a href="javascript:;" class="lookover authorityBtn" style="color:#6ba1ff;">编辑</a><a href="javascript:;" href="" class="delect delete authorityBtn" style="color:#6ba1ff; margin-left: 10px;">删除</a></td>'
                            }else{
                                str +='<td><a href="javascript:;" class="authorty authorty1 authorityBtn" style="color: #6ba1ff; margin-right: 5px;">分配权限</a><a href="javascript:;" class="lookover authorityBtn" style="color:#6ba1ff;">编辑</a><a href="javascript:;" href="" class="delect delete authorityBtn" style="color:#6ba1ff; margin-left: 10px;">删除</a></td>'
                            }
							str+='</tr>'

                        }
						
                        $('#apartmentListInfo').html(str);
                        //            权限控制
                        if(AuthSwitch==1){
                            getAuthor11()
                        }
                        // var result = template('apartmentListTpl', {list: json.data});
                        // $('#apartmentListInfo').html(result);
                        //分配权限
                        $(".authorty1").unbind();
                        $(".authorty1").click(function () {
                            sessionStorage.setItem("roleId",$(this).parents("tr").attr("data-id"));
                            sessionStorage.setItem("isRole","1");
                            window.location.href="./authorityManage.html"
                        })

                        //启用和禁用
						$(".chooseswitch input[type='checkbox']").change(function() {
						    console.log($(this).prop("checked"));
						    
						    if($(this).prop("checked")){
						        status_apartment($(this).parent().parent().attr('data-id'), 0);
						    }else {
						        status_apartment($(this).parent().parent().attr('data-id'), 1);
						    }
						});

                       //  totalPage = json.count%size == 0 ? totalPage : (totalPage + 1);
                       // console.log(totalPage);
                        if (isSearch == 1) {
                            // if (isFirst) {

                                Page({
                                    num: json.totalPage,
                                    elem: $('#page1'),
                                    callback: function(n) {
                                        apartment_list(n, size);
                                    }
                                });

                            $('.total').text(json.totalPage+'页,共'+json.count+'条');
                                isFirst = false;

                            // }

                            $('.allPageN').text(num+1+'/'+json.totalPage);
                        }

                        isSearch = 0;

                        if (isFirst) {

                            Page({
                                num: json.totalPage,
                                elem: $('#page1'),
                                callback: function(n) {
                                    apartment_list(n, size);
                                }
                            });

                            $('.total').text(json.totalPage+'页,共'+json.count+'条');
                            isFirst = false;
                        }

                        $('.allPageN').text(num+'/'+json.totalPage);
                    } else {
                        $('.pageJump').css('display', 'none');    
                    }
                } else {
                    $('.pageJump').css('display', 'none');
                }

            },
            error: function (err) {
                console.log(err);
            }

        });
    }

    // 新增角色
    $(document).on('click', '.add_apartment', function() {
    	$(window.parent.document).find('.model38_ok_btn').attr('data-apartid', '');
    	$(window.parent.document).find('.role_name').val('');
    	$(window.parent.document).find('.job_describe').val('');
    	$(window.parent.document).find('.suoshu_department span').text('请选择');
    	$(window.parent.document).find('.suoshu_department').attr('data-selectedindex', '0');
    	window.parent.department_list();
    	window.parent.showModelBox('.modelBox38');

    });

    // 添加角色
    // $(window.parent.document).on('click', '.model35_ok_btn', function() {
    window.parent.$('.model38_ok_btn').unbind();
    window.parent.$('.model38_ok_btn').click(function() {
    	var apartment_name = $(window.parent.document).find('.role_name').val();
    	var zhineng_descript = $(window.parent.document).find('.job_describe').val();
    	var departmentId = $(window.parent.document).find('.suoshu_department').attr('data-selectedindex');
    	var departmentName = $(window.parent.document).find('.suoshu_department span').text();

    	if(apartment_name==""){
            window.parent.$(".modelBox38 .errMsg").text("请填写角色名称")
			return;
		}
        if(departmentId==0 || departmentId==-1){
            window.parent.$(".modelBox38 .errMsg").text("请选择所属部门")
            return;
        }
        if(zhineng_descript==""){
            window.parent.$(".modelBox38 .errMsg").text("请填写职能描述")
            return;
        }
    	if ($(this).attr('data-apartId')) {
    		id = $(this).attr('data-apartId');
    		update_apartment(apartment_name, zhineng_descript, departmentId, departmentName, id);
    	} else {
    		// id = '';
    		add_apartment(apartment_name, zhineng_descript, departmentId, departmentName);
    	}
    	
    	

    });

    function add_apartment(apartment_name, zhineng_descript, departmentId, departmentName) {
    	console.log(apartment_name, zhineng_descript, departmentId, departmentName);
    	$.ajax({
            url: pubIP + 'tReceptionRole/addWLTReceptionRoleInfo',
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                roleName: apartment_name,
                departmentId: departmentId,
                departmentName: departmentName,
                roleDescribe: zhineng_descript
                // id: id
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);
                if (json.code == 1) {
                	$(window.parent.document).find('.modelBox38').hide();
                	
                	$(window.parent.document).find('.innerSuccmsg').html('<span>添加成功！</span>');
                	
                	window.parent.showModelBox('.all_success_alert');
                }
            },
            error: function(err){
            	console.log(err);
            }
        });
    }

    function update_apartment(apartment_name, zhineng_descript, departmentId, departmentName, id) {
    	$.ajax({
            url: pubIP + 'tReceptionRole/upWLTReceptionRoleInfo',
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                roleName: apartment_name,
                roleDescribe: zhineng_descript,
                id: id,
                departmentId: departmentId,
                departmentName: departmentName
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);
                if (json.code == 1) {
                	$(window.parent.document).find('.modelBox38').hide();
                	
                	$(window.parent.document).find('.innerSuccmsg').html('<span>修改成功！</span>');
                	
                	
                	window.parent.showModelBox('.all_success_alert');
                }
            },
            error: function(err){
            	console.log(err);
            }
        });
    }
    
    $(window.parent.document).on('click', '.all_success_alert .modelbtn.confirm', function() {
    	
    	window.location.reload();
    });

    // 排序方式
    // $('.sort_method ul li').click(function() {
    // 	apartment_list(1, $(this).parent().parent().attr('data-selectedindex'), 10);
    // });

    // 编辑
    $(document).on('click', '.lookover', function() {
    	// console.log($(this).parent().parent().find('.ord_name').text());
    	$(window.parent.document).find('.role_name').val($(this).parent().parent().find('.roleName_td').text());
    	var describe = $(this).parent().parent().find('.describe').text();
    	if (describe == '暂无数据') {
    		describe = '';
    	}
    	$(window.parent.document).find('.job_describe').val(describe);

    	$(window.parent.document).find('.suoshu_department span').text($(this).parent().parent().find('.ord_name').text());
    	$(window.parent.document).find('.suoshu_department').attr('data-selectedindex', $(this).parent().parent().find('.ord_name').attr('data-bumen'));

    	$(window.parent.document).find('.model38_ok_btn').attr('data-apartId', $(this).parent().parent().attr('data-id'));
    	window.parent.department_list();
    	window.parent.showModelBox('.modelBox38');

    });

   	// 删除
    $(document).on('click', '.delete', function() {
        window.parent.warn_alert($(this).parent().parent().attr('data-id'), '是否确认要删除？');
    });

    // 删除
    window.parent.$('.all_sure').unbind();
    // $(window.parent.document).on('click', '.all_sure', function() {
    window.parent.$('.all_sure').click(function() {

        del($(this).attr('data-this'));

    })

    function del(_this) {
//   		var data_id = _this.parent().parent().attr('data-id');
        var data_id=_this;
   		$.ajax({
            url: pubIP + 'tReceptionRole/delWLTReceptionRoleInfo',
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                id: data_id
            },
            dataType: 'json',
            success: function (json) {
                if (json.code == 1) {
                	cf_alert(1, '删除成功！');
                } else if (json.code == -1) {
                    cf_alert(2, json.msg);
                }

            },
            error: function(err) {
            	console.log(err);
            }
        });
    }

   	// });

   	function status_apartment(id, status) {
    	$.ajax({
            url: pubIP + 'tReceptionRole/upWLTReceptionRoleInfo',
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                status: status,
                id: id
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);
                if (json.code == 1) {
                	$(window.parent.document).find('.modelBox38').hide();
                	
                	$(window.parent.document).find('.innerSuccmsg').html('<span>修改成功！</span>');
                	
                	
                	window.parent.showModelBox('.all_success_alert');
                }
            },
            error: function(err){
            	console.log(err);
            }
        });
    }

</script>
</body>
</html>
