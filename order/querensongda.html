<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" CONTENT="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta name="format-detection" content="telephone=no" />
    <title adct1="acount" adct="首页">新疆化学品经营服务平台</title>
    <link rel="stylesheet" type="text/css" href="../css/commin.css"/>
    <!-- <title>确认送达</title> -->
    <link rel="stylesheet" href="../css/querensongda.css">
</head>
<body>
    <div class="modelBox18" style="font-size: 14px;">
        <div class="modelCont" style="width: 1070px;height: 625px;overflow-x: hidden;">
            <div class="modeltitle" style="width: 100%;">
                <span>订单信息</span>
                <img class="close" style="float: right;cursor: pointer;" height="50" src="../img/gsxq_del.png" alt="">
            </div>
            <div class="modelcontent clearFloat" style="width:1000px;height: 560px; overflow-y:auto; font-size: 14px;padding: 15px 50px 0 30px; ">
                <div style="height: 246px; width: 968px; border: 1px solid #ebe9ea;padding-left: 40px; padding-top: 8px; box-sizing: border-box; margin-top: 17px;">
                   <div class="clearfix">
                        <div class="" style="display: inline-block; width: 50%; float: left;">
                            <ul>
                                <li>订单编号：<span class="order_no">201707196369321</span></li>
                                <li>发布时间：<span class="publish_time">2015-06-07 23:00</span></li>
                                <li>装车时间：<span class="zhuangche_time">2015-06-07 23:00</span></li>
                            </ul>
                        </div>
                        <div style="display: inline-block; float: left;">
                            <ul>
                                <li style="width: 450px;white-space: nowrap;text-overflow: ellipsis;overflow: hidden;">始发地：<span class="start_address">新疆-乌鲁木齐-xxxx区-xxxx路-xxxx号xxx详情</span></li>
                                <li style="width: 450px;white-space: nowrap;text-overflow: ellipsis;overflow: hidden;" class="clearfix"><i class="fl">目的地：</i><span style="display: inline-block; width: 328px; float: left;" class="end_address">新疆-乌鲁木齐-xxxx区-xxxx路-xxxx号xxx详情中华人民共和国北京市东城区朝阳花园</span></li>
                            </ul>
                        </div>
                   </div>
                   <div class="order_info_ul">
                       <ul>
                           <li>货物类型：<span class="good_type">危化</span></li>
                           <li>重&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;量：<span class="zhongliang">150吨</span></li>
                           <li>支付方式：<span class="pay_method2">预付</span></li>
                           <!-- <li>保证金：<span class="baozhengjin">￥1000.00</span></li> -->
                       </ul>
                       <ul>
                           <li>包装类型：<span class="baozhuang_type">灌装</span></li>
                           <li>开&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;票：<span class="kaipiao">普票</span></li>
                           <!-- <li>结算方式：<span class="jiesuan_method">现汇</span></li>
                           <li>缴纳方式：<span class="jiaona_method">抵扣</span></li> -->
                       </ul>
                       <ul>
                           <li>货物名称：<span class="good_name">片碱</span></li>
                           <li>车辆类型：<span class="car_type">罐装车</span></li>
                           <!-- <li>回&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;单：<span class="huidan">预付</span></li> -->
                           <li style="width: 300px;white-space: nowrap;text-overflow: ellipsis;overflow: hidden;">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：<span class="beizhu">备注信息</span></li>
                       </ul>
                   </div>
                </div>
                <div class="clearfix">
                    <div class="clearfix">
                        <div class="fl">
                            <ul class="order_info_ul2">
                                <li class="current">新bw12356（内部）</li>
                                <li>新bw12356（内部）</li>
                                <li>新bw12356（内部）</li>
                            </ul>
                        </div>
                        <div class="order_info_div">
                            <div class="info_title">
                                <ul class="clearfix">
                                    <li class="w">
                                        <div>总&nbsp;&nbsp;&nbsp;&nbsp;计：</div>
                                        <div class="ml">￥<span class="zongji_money">0.00</span></div>
                                    </li>
                                    <li class="span">
                                        <span></span>
                                    </li>
                                    <li class="w">
                                        <div>总支付：</div>
                                        <div class="ml">￥<span class="zongzhifu_money">0.00</span></div>
                                    </li>
                                    <li class="span">
                                        <span></span>
                                    </li>
                                    <li class="w">
                                        <div>税&nbsp;&nbsp;&nbsp;&nbsp;后：</div>
                                        <div class="ml">￥<span class="shuihou_money">0.00</span></div>
                                    </li>
                                </ul>
                            </div>
                            <div class="order_detail">
                                <div class="centera">
                                    <ul id="oranger"> 
                                        <li class="tab1_yfk hover" data-money="0">预付款</li>
                                        <li class="tab2_ddxx" data-money="0">运单信息</li>
                                        <li class="tab3_kk" data-money="0">扣款项</li>
                                        <li class="tab4_js" data-money="0">结算</li>
                                    </ul>
                                    <div id="tablea" class="tablea">
                                        <div class="box">
                                            <div style="width: 530px; margin: 0 auto;">
                                                <div class="clearfix">
                                                    <div class="fl" style="margin-top: 30px; line-height: 40px;">
                                                        <span style="color: #666666; width: 156px; text-align: right;display: inline-block;">预付金：￥<span style="color: #333; font-size: 18px;" class="yufujin">1000.00</span></span>
                                                    </div>
                                                    <div class="fr" style="margin-top: 30px;color: #666666; font-size: 14px; line-height: 40px;"><span style="color: #282828;" class="modelBox34LeftTitle">返还：</span>
                                                        <input class="yufujin_back all_input" type="text" placeholder="" style="height: 36px;width: 190px;border: 1px solid #dbdbdc; ">
                                                    </div>
                                                </div>
                                                <div class="quan_lists">
                                                    
                                                </div>
                                            </div>
                                        </div>
                                        <div class="box">
                                            <div class="" style="height: 370px;">
                                                <div class="" style="width: 666px; margin: 0 auto;">
                                                    <div style="margin-top: 14px; color: #333; font-size: 14px;">发车信息</div>
                                                    <div class="clearfix">
                                                        <div class="fl" style="margin-top: 30px;color: #666666; font-size: 14px; line-height: 40px;"><span style="color: #282828; display: inline-block; width: 70px; text-align: right;" class="modelBox34LeftTitle">单号：</span>
                                                            <input type="text" placeholder="" style="height: 36px;width: 190px;border: 1px solid #dbdbdc; " class="xx_fhdh all_input">
                                                        </div>
                                                        <div class="fr" style="margin-top: 30px;color: #666666; font-size: 14px; line-height: 40px;"><span style="color: #282828;" class="modelBox34LeftTitle">重量/体积：</span>
                                                            <input type="text" placeholder="" style="height: 36px;width: 190px;border: 1px solid #dbdbdc; " class="xx_zzjs all_input">
                                                        </div>
                                                    </div>
                                                    <div class="clearfix">
                                                        <div class="fl" style="margin-top: 30px;color: #666666; font-size: 14px; line-height: 40px;"><span style="color: #282828;" class="modelBox34LeftTitle">发货时间：</span>
                                                            <input type="text" class="date-input laydate-icon publishTime input xx_fhsj all_input" placeholder="请选择日期" id="test1" style="height: 36px;width: 170px;border: 1px solid #dbdbdc; ">
                                                        </div>
                                                        <div class="fr" style="margin-top: 30px;color: #666666; font-size: 14px; line-height: 40px;"><span style="color: #282828;" class="modelBox34LeftTitle">结车价：</span>
                                                            <input type="text" placeholder="" style="height: 36px;width: 190px;border: 1px solid #dbdbdc; " class="xx_jcj">
                                                        </div>
                                                    </div>
                                                    <div class="clearfix">
                                                        <div class="fl" style="margin-top: 30px;color: #666666; font-size: 14px; line-height: 40px;"><span style="color: #282828; display: inline-block; width: 70px; text-align: right;" class="modelBox34LeftTitle">扣损率：</span>
                                                            <input type="text" placeholder="" style="height: 36px;width: 190px;border: 1px solid #dbdbdc; " class="xx_ksl">
                                                        </div>
                                                        <div class="fr" style="margin-top: 30px;color: #666666; font-size: 14px; line-height: 40px;"><span style="color: #282828;" class="modelBox34LeftTitle">扣损单价：</span>
                                                            <input type="text" placeholder="" style="height: 36px;width: 190px;border: 1px solid #dbdbdc; " class="xx_ksdj">
                                                        </div>
                                                    </div>
                                                    <div style="margin-top: 25px; margin-bottom: 20px;" class="clearfix">
                                                        <span style="float: left; text-align: right;">发货磅单：</span>
                                                        <div class="upload_div" style="position: relative; height: 130px;width: 130px; margin-left: 5px; border: 1px solid #dbdbdc; float: left;">
                                                        </div>
                                                        <div style="position: relative; display: inline-block;margin-top: 114px; margin-left: 10px; cursor: pointer;"><input type="file" id="upload_btn2"><span style="color: #6ea3ff;">上传</span></div>
                                                        <input type="hidden" value="" class="upload_div_hide1">
                                                    </div>
                                                </div>
                                                <div class="" style="width: 666px; margin: 0 auto;">
                                                    <div style="margin-top: 14px; color: #333; font-size: 14px;">收车信息</div>
                                                    <div class="clearfix">
                                                        <div class="fl" style="margin-top: 30px;color: #666666; font-size: 14px; line-height: 40px;"><span style="color: #282828; display: inline-block; width: 70px; text-align: right;" class="modelBox34LeftTitle">单号：</span>
                                                            <input type="text" placeholder="" style="height: 36px;width: 190px;border: 1px solid #dbdbdc; " class="xx_scdh all_input">
                                                        </div>
                                                        <div class="fr" style="margin-top: 30px;color: #666666; font-size: 14px; line-height: 40px;"><span style="color: #282828;" class="modelBox34LeftTitle">重量/体积：</span>
                                                            <input type="text" placeholder="" style="height: 36px;width: 190px;border: 1px solid #dbdbdc; " class="xx_sczl all_input">
                                                        </div>
                                                    </div>
                                                    <div class="clearfix">
                                                        <div class="fl" style="margin-top: 30px;color: #666666; font-size: 14px; line-height: 40px;"><span style="color: #282828;" class="modelBox34LeftTitle">到货时间：</span>
                                                            <input type="text" class="date-input laydate-icon publishTime input all_input" placeholder="请选择日期" id="test2" style="height: 36px;width: 170px;border: 1px solid #dbdbdc;">
                                                        </div>
                                                    </div>
                                                 
                                                    <div style="margin-top: 25px; margin-bottom: 20px;" class="clearfix">
                                                        <span style="float: left; text-align: right;">收货磅单：</span>
                                                        <div class="upload_div" style="position: relative; height: 130px;width: 130px; margin-left: 5px; border: 1px solid #dbdbdc; float: left;">
                                                        </div>
                                                        <div style="position: relative; display: inline-block;margin-top: 114px; margin-left: 10px; cursor: pointer;"><input type="file" id="upload_btn1"><span style="color: #6ea3ff;">上传</span></div>
                                                        <input type="hidden" value="" class="upload_div_hide2">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="box">
                                            <ul class="koukuan_list">
                                                
                                            </ul>
                                        </div>
                                         <div class="box">
                                            <div class="my_tab">
                                                <input type="radio" name="myradio1" id="myradio1" checked>
                                                <label for="myradio1">现结</label>
                                                <input type="radio" name="myradio1" id="myradio2" style="margin-left: 20px;">
                                                <label for="myradio2">工资</label>
                                            </div>
                                            <ul class="js_type">
                                                <!-- 现结 -->
                                                <li class="xj_mylist xj_mylist1 thisShow">
                                                    <div class="js_allmoney"><span>结算金额：</span><input type="text" class="all_jsje all_input"></div>
                                                    <div class="add_djq">
                                                        <div class="gz_ticheng" style="display: none;margin-bottom: 20px;"><span>提&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;成：</span><input type="text" class="ticheng jiajia"></div>
                                                        <div><span class="gz_xianjin">现&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;金：</span><input type="text" class="xianjin jiajia"></div>
                                                        <ul class="daijinquan_type">
                                                            <!-- 券的种类 -->
                                                        </ul>
                                                    </div>
                                                    <div class="sjjs_allmoney"><span>实际现结：</span><input type="text" class="all_input"></div>
                                                </li>
                                                <!-- 工资 -->
                                                <!-- <li class="gz_mylist xj_mylist2" style="display: none;">
                                                    <div class="js_allmoney"><span>结算金额：</span><input class="all_jsje" type="text"></div>
                                                    <div class="add_djq">
                                                        <div><span>提&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;成：</span><input type="text" class="ticheng jiajia" data-types="2"></div>
                                                        <div style="margin-top: 20px;"><span>工&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;资：</span><input type="text" class="gongzi jiajia" data-types="2"></div>
                                                        <ul class="daijinquan_type" data-types="2">
                                                           
                                                        </ul>
                                                    </div>
                                                    <div class="sjjs_allmoney"><span>实际工资：</span><input type="text"></div>
                                                </li> -->
                                            </ul>
                                            <div class="qr_clxx"><span>确认此车辆信息</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- <div class="clearFloat" style="text-align: center;margin-top: 28px; margin-bottom: 50px;">
                        <span class="cf_btn cancel cfClose quxiao" style="display: inline-block;" >取消</span>
                        <span class="cf_btn btn_queren" style="display: inline-block; width: 190px;height: 40px;line-height: 40px; margin-left: 20px; ">确认收货</span>
                    </div> -->
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" class="inp_hidden">

    <script src="../js/jquery-3.2.1.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
    <script src="../laydate/laydate.js" type="text/javascript" charset="utf-8"></script>
    <script>
        laydate({
            elem: '#test1',
            format: 'YYYY-MM-DD',
            istime: true,
            choose: function(dates){ //选择好日期的回调
                startTime = dates;
            }
        });
        laydate({
            elem: '#test2',
            format: 'YYYY-MM-DD',
            istime: true,
            choose: function(dates){ //选择好日期的回调
                startTime = dates;
            }
        });

        // 上传图片
        $(document).on('change','#upload_btn1,#upload_btn2',function(){
            xmTanUploadImg11(this);
        })
        
        function xmTanUploadImg11(obj) {
            var file = obj.files[0];
            if (file.size >= 2097152) {
                window.parent.$(".all_error_alert").show();
                window.parent.$(".all_error_alert").find(".innerErrmsg").html("上传的图片超过了2MB");
                return;
            }
    
            var formdata=new FormData();
    
            formdata.append('file', file);
            
            $.ajax({
                url: uplodImgPath,
                type: 'post',
                processData: false,  // 告诉jQuery不要去处理发送的数据
                contentType: false,   // 告诉jQuery不要去设置Content-Type请求头
                data: formdata,
                cache: false,
                dataType: 'json',
                success: function (data) {
                    //console.log(data);
                    $(obj).parent().parent().find('.upload_div').css({
                            'background':'url('+data.url+') no-repeat',
                            'background-position':'center',
                            'background-size':'contain',
                            'background-color':'#f6f6f6'
                    });
                    $(obj).parent().parent().find('input[type="hidden"]').val(data.url);
                    // $(obj).parent().parent().next().css('display', 'none');
                },
                error: function (err) {
                    console.log(err);
                }
            });
    
        }

        //税率
        var ggsl = 0.2;
        //获取订单id
        var tloId = sessionStorage.getItem("qrsd_tloId");
        //var tloId = "1";
        // 详情信息
        $.ajax({
            url: pubIP + 'order/getOrderByid',
            type: 'get',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                tloid: tloId
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log("[[[[[[[[[[[[[[[[[[[[[[[[[[[[");
                console.log(json);

                json.data.createTime = new Date(json.data.createTime).Format("yyyy-MM-dd hh:mm");
                json.data.startDate = new Date(json.data.startDate).Format("yyyy-MM-dd hh:mm");
                //订单号
                $('.order_no').text(json.data.orderNo);
                $('.publish_time').text(json.data.createTime);
                $('.zhuangche_time').text(json.data.startDate);

                $('.start_address').text(json.data.sendAddress);
                $('.start_address').attr("title",json.data.sendAddress);
                $('.end_address').text(json.data.receiveAddress);
                $('.end_address').attr("title",json.data.receiveAddress);
                $('.good_type').text(json.data.goodsType);
                $('.zhongliang').text(json.data.goodsNum+json.data.goodsUnit);
                $('.zhongliang').attr("data-zl",json.data.goodsNum);

                $('.pay_method2').text(json.data.paymentType);
                
                $('.baozhuang_type').text(json.data.packageType);
                $('.kaipiao').text(json.data.invoiceType);
                
                $('.good_name').text(json.data.goodsName);

                $('.car_type').text(json.data.carType);
                $('.beizhu').text(json.data.goodsRemark);
                $('.beizhu').attr("title",json.data.goodsRemark);
                //单价
                var danjia = Number(json.data.unitPrice);
                $(".inp_hidden").val(danjia);
                //结车价
                $(".xx_jcj").val(danjia);
                //重量
                // var zhongliang = Number(json.data.goodsNum);
                // //总价
                // $(".zongji_money").html((danjia*zhongliang).toFixed(2));
                //初始算下总支付
                var all_zzf = Number($(".zongji_money").html())-Number($(".tab1_yfk").attr("data-money"))-Number($(".tab2_ddxx").attr("data-money"))-Number($(".tab3_kk").attr("data-money"));
                $(".zongzhifu_money").html(all_zzf.toFixed(2));
                $(".shuihou_money").html((all_zzf*(1-ggsl)).toFixed(2));
                $(".all_jsje").val((all_zzf*(1-ggsl)).toFixed(2));
            },
            error: function(err) {
                console.log(err);
            }
        });

        //右侧四个tab重置方法
        function tabReset(){
            $(".zongji_money").html('0.00');
            $(".zongzhifu_money").html('0.00');
            $(".shuihou_money").html('0.00');//上面三个总价重置
            $(".gz_ticheng").hide().find(".ticheng").val('');
            $(".gz_xianjin").html('现&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;金：').next(".xianjin").val('');
            $(".sjjs_allmoney").find("span").html('实际现结：');
            $(".sjjs_allmoney").find("input").html('');
            $(".qr_clxx span").css("background","#6ba1ff");
            $(".btn_queren").css("background","#6ba1ff");

            $(".daijinquan_type").html('');
            add_djqclk();//第四步代金券重置
            $(".koukuan_list").html('');
            add_thisclk();//扣款项重置
            $(".xx_jcj").val($(".inp_hidden").val());//结车价重置为订单单价
            $(".all_input").val('');//重置所有手输input框
            $(".upload_div").css("background","");
        }

        //获取车辆信息
        huoqu_msg();
        function huoqu_msg(){
            $.ajax({
                url: pubIP + 'order/getCarUserListByOrderId',
                type: 'get',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    orderId: tloId,
                    status: 0
                },
                cache: false,
                dataType: 'json',
                success: function (json) {
                    console.log("+++++++++++++++++++++++++++++");
                    console.log(json);
                    if (json.code == 1) {
                        if(json.data.length==0){
                            window.parent.$(".all_error_alert").show();
                            window.parent.$(".all_error_alert").find(".innerErrmsg").html("该订单已全部结算完成，确认送达");
                            window.parent.$(".modelBox18_ifrm").hide();
                            window.parent.$("#suerSongda").attr("src","");
                        }
                        var str = '';
                        for (var i = 0; i < json.data.length; i++) {
                            json.data[i].planStartDate = new Date(json.data[i].planStartDate).Format("yyyy-MM-dd hh:mm");
                            json.data[i].planEndDate = new Date(json.data[i].planEndDate).Format("yyyy-MM-dd hh:mm");
                            
                            if (json.data[i].tlvType == 0) {
                                json.data[i].tlvType2 = '内部';
                            } else if (json.data[i].tlvType == 1) {
                                json.data[i].tlvType2 = '外部';
                            }
                            str += '<li data-carid="'+json.data[i].carid+'" data-ids="'+json.data[i].id+'" id="'+json.data[i].driverid+'" data-type="'+json.data[i].tlvType+'" data-tLogisticsOrderId="'+json.data[i].tLogisticsOrderId+'">'+json.data[i].carNo+'（'+json.data[i].tlvType2+'）</li>';
                        }
                        $('.order_info_ul2').html(str);
                        //点击车辆显示右侧信息
                        $(".order_info_ul2 li:first-child").addClass("active");
                        //$(".order_info_ul2 li:first-child").click();
                        $(".order_info_ul2 li").on("click",function(){
                            $(".order_info_ul2 li").removeClass("active");
                            $(this).addClass("active");
                            seachMsg($(this).attr("id"));//刷新预付金
                            tabReset();//重置其他
                            var datas = $(this).attr("data-type");
                            if (datas == 0) {
                                $("#myradio1").hide().attr("checked",false);
                                $("#myradio1").next().hide();
                                $("#myradio2").prop("checked",true);
                                $(".gz_ticheng").show().find(".ticheng").val('');
                                $(".gz_xianjin").html('工&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;资：').next(".xianjin").val('');
                                $(".sjjs_allmoney").find("span").html('实际工资：');
                                $(".sjjs_allmoney").find("input").html('');
                            } else if (datas == 1) {
                                $("#myradio1").show().prop("checked",true);
                                $("#myradio1").next().show();
                                $("#myradio2").attr("checked",false);
                            }
                        })
                        
                    }
                },
                error: function(err) {
                    console.log(err);
                }

            });
        }
        
        
        //查询车辆预付款信息(不传司机id时查看全部)
        seachMsg('');
        //用掉的预付金
        var saleyfmoney = 0;
        function seachMsg(driverId){
            $.ajax({
                url: pubIP + 'order/queryAllocatingCarList',
                type: 'POST',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    companyId: '1',
                    orderId: tloId,
                    driverId: driverId,
                    status: 0
                },
                cache: false,
                dataType: 'json',
                success: function (data) {
                    console.log("--------------------------------------");
                    console.log(data.data[0]);
                    var thisdata = data.data[0]
                    //折损率
                    $(".xx_ksl").val(thisdata.car.departureLoss);
                    //折损单价
                    $("xx_ksdj").val(thisdata.car.departureLossPrice);
                    

                    $(".yufujin").html(data.data[0].car.money);
                    $(".yufujin_back").attr("data-id",data.data[0].car.id);
                    $(".yufujin_back").attr("yfj_backs",data.data[0].car.money);
                    var data =data.data[0].listTCouponrec;
                    var str = '';
                    $.each(data,function(idx,item){
                        str += '<div class="clearfix">'
                        str += '<div class="fl" style="margin-top: 15px; line-height: 40px;">'
                        str += '<span style="color: #666666; width: 156px; text-align: right;display: inline-block;">'
                        str += '<span class="quan_names">'+item.name+'：</span>'
                        str += '￥<span class="quan_moneys" style="color: #333; font-size: 18px;" data-yfje="'+item.money+'">'+item.money+'</span>'
                        str += '</span>'
                        str += '</div>'
                        str += '<div class="fr" style="margin-top: 15px;color: #666666; font-size: 14px; line-height: 40px;"><span style="color: #282828;" class="modelBox34LeftTitle">返还：</span>'
                        str += '<input class="quan_backmoneys" type="text" data-maxmoney="'+item.money+'" placeholder="" style="height: 36px;width: 190px;border: 1px solid #dbdbdc;" id='+item.id+'>'
                        str += '</div>'
                        str += '</div>'
                    })
                    $(".quan_lists").html(str);
                    //预付优惠券金额
                    var this_jine=0;
                    var allback_money=0;
                    var yfjjj = Number($(".yufujin").html());
                    var yfjfhje=0;
                    $(".quan_moneys").each(function(){
                        this_jine += Number($(this).attr("data-yfje"))
                    });
                    
                    //返还优惠券金额
                    $(".quan_backmoneys").on("input",function(){
                        allback_money=0;
                        $(".quan_backmoneys").each(function(){
                            if(Number($(this).val())>Number($(this).attr("data-maxmoney"))){
                                $(this).val($(this).attr("data-maxmoney"));
                            }
                            allback_money += Number($(this).val())
                        });
                        //用掉的预付金 = 总预付金额- 返还的预付金(tab第一个全部金额计算)
                        saleyfmoney = (this_jine+yfjjj)-(allback_money+yfjfhje);
                        $(".tab1_yfk").attr("data-money",saleyfmoney);
                        var all_zzf = Number($(".zongji_money").html())-Number($(".tab1_yfk").attr("data-money"))-Number($(".tab2_ddxx").attr("data-money"))-Number($(".tab3_kk").attr("data-money"));
                        $(".zongzhifu_money").html(all_zzf.toFixed(2));
                        $(".shuihou_money").html((all_zzf*(1-ggsl)).toFixed(2));
                        $(".all_jsje").val((all_zzf*(1-ggsl)).toFixed(2));
                    })
                    //预付金返还单算
                    $(".yufujin_back").on("input",function(){
                        if(Number($(this).val())>Number($(this).attr("yfj_backs"))){
                            $(this).val($(this).attr("yfj_backs"));
                        }
                        yfjfhje = Number($(this).val());
                        //用掉的预付金 = 总预付金额- 返还的预付金(tab第一个全部金额计算)
                        saleyfmoney = (this_jine+yfjjj)-(allback_money+yfjfhje);
                        $(".tab1_yfk").attr("data-money",saleyfmoney);
                        var all_zzf = Number($(".zongji_money").html())-Number($(".tab1_yfk").attr("data-money"))-Number($(".tab2_ddxx").attr("data-money"))-Number($(".tab3_kk").attr("data-money"));
                        $(".zongzhifu_money").html(all_zzf.toFixed(2));
                        $(".shuihou_money").html((all_zzf*(1-ggsl)).toFixed(2));
                        $(".all_jsje").val((all_zzf*(1-ggsl)).toFixed(2));
                    })
                    
                },
                error: function(err) {
                    console.log(err);
                }
            })
        }
        
        //运单信息计算总价
        function xxjszj(){
            //货物单价
            var hwdj = $(".inp_hidden").val()-0;
            //折损率
            var thiszsl = $(".xx_ksl").val();
            //折损单价
            var thiszsdj = $(".xx_ksdj").val();
            //重量
            var thishwzl = $(".xx_zzjs").val();
            $(".zongji_money").html(Number(thishwzl)*hwdj);

            if(thiszsl!=''&&thiszsl!=null){
                var ydxxMoney = Number(thishwzl)*hwdj*(Number(thiszsl));
                $(".tab2_ddxx").attr("data-money",ydxxMoney);
            }else if(thiszsdj!=''&&thiszsdj!=null){
                var ydxxMoney2 = Number(thishwzl)*(Number(thiszsdj));
                $(".tab2_ddxx").attr("data-money",ydxxMoney2);
            } else{
                var ydxxMoney3 = Number(thishwzl)*hwdj;
                $(".tab2_ddxx").attr("data-money","0");
            }
            var all_zzf = Number($(".zongji_money").html())-Number($(".tab1_yfk").attr("data-money"))-Number($(".tab2_ddxx").attr("data-money"))-Number($(".tab3_kk").attr("data-money"));
            $(".zongzhifu_money").html(all_zzf.toFixed(2));
            $(".shuihou_money").html((all_zzf*(1-ggsl)).toFixed(2));
            $(".all_jsje").val((all_zzf*(1-ggsl)).toFixed(2));
        }
        //重量改变总计
        $(".xx_zzjs").on("input",function(){

            xxjszj();
        })
        //折损率改变总计
        $(".xx_ksl").on("input",function(){
            xxjszj();
        })
        //折损单价改变总计
        $(".xx_ksdj").on("input",function(){
            xxjszj();
        })

        //新增扣款项
        var isFrist3 = true;
        $(".tab3_kk").on("click",function(){
            if(!isFrist3){
                return;
            }
            add_thisclk();
            isFrist3 = false;
        })
       
        function add_thisclk(aa){
            
            $(aa).hide();
            $(aa).next().show();
            $.ajax({
                url: pubIP + 'buckle/getDeductMoneyList',
                type: 'POST',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    companyId: '1',
                    //orderId: tloId,
                    status: '0',
                },
                cache: false,
                dataType: 'json',
                success: function (data) {
                    console.log("------------------++++-----------------");
                    var data = data.data.data;
                    console.log(data);
                    var str2 = '';
                    var str3 = '';
                    $.each(data,function(idx,item){
                        str3 += '<li data-index='+idx+' id='+item.id+'>'+item.name+'</li>';
                    })
                    str2+='<li class="kk_thislist">'
                    str2+='<div class="lf lf_select">'
                    str2+='<span>扣款项：</span>'
                    str2+='<div class="goodsType input select myselect" style="float: none;margin: 0" data-selectedindex="-1"><span  class="all_kkx">请选择</span><img src="../img/prl-select.jpg" >'
                    str2+='<ul style="top: 35px;">'+str3+'</ul>'
                    str2+='</div>'
                    str2+='</div>'
                    str2+='<div class="inp_koukuan fr">'
                    str2+='<input class="kk_money" type="text" placeholder="请输入扣款金额">'
                    str2+='<span class="add_this" onclick="add_thisclk(this)">新增</span>'
                    str2+='<span style="display: none;" class="dele_this" onclick="dele_thisclk(this)">删除</span>'
                    str2+='</div>'
                    str2+='</li>'
                    $(".koukuan_list").append(str2);

                     //扣款金额
                     var kkallback_money=0;
                     $(".kk_money").on("input",function(){
                        kkallback_money=0;
                        $(".kk_money").each(function(){
                            kkallback_money += Number($(this).val())
                        });
                       
                        $(".tab3_kk").attr("data-money",kkallback_money);
                        var all_zzf = Number($(".zongji_money").html())-Number($(".tab1_yfk").attr("data-money"))-Number($(".tab2_ddxx").attr("data-money"))-Number($(".tab3_kk").attr("data-money"));
                        $(".zongzhifu_money").html(all_zzf.toFixed(2));
                        $(".shuihou_money").html((all_zzf*(1-ggsl)).toFixed(2));
                        $(".all_jsje").val((all_zzf*(1-ggsl)).toFixed(2));
                    })

                    // 模拟下拉框
                    $(".select").unbind();//解除所有绑定事件 再重新注册
                    $('.select').click(function(event){
                        if($(this).attr("disabled")=="disabled"){return;}//不可选
                        if($(this).children('img').attr('src') == '../img/prl-selected.jpg'){
                            $(this).children('img').attr('src', '../img/prl-select.jpg')
                        } else {
                            $(this).children('img').attr('src', '../img/prl-selected.jpg')
                        }
                        event.stopPropagation();
                        $(this).children('ul').toggle();
                        var that = $(this);
                        that.find('li').each(function(){
                            $(this).mouseover(function(){
                                $(this).addClass('hovered')
                            });
                            $(this).mouseleave(function(){
                                $(this).removeClass('hovered')
                            });
                            if($(this).attr('data-index') == that.attr('data-selectedindex')){
                                $(this).css({'background': '#6ea3ff','color': '#fff'});
                                $(this).siblings('li').css({'background': '#fff','color': '#999'});
                            }
                        });
                    }).mouseleave(function (event) {
                        $(this).children('img').attr('src', '../img/prl-select.jpg');
                        $(this).children('ul').hide();
                    });
                    $('.select ul li').click(function(){
                        event.stopPropagation();
                        $(this).parent().parent().attr('data-selectedindex', $(this).attr('data-index'));
                        $(this).parent().parent().find('span').attr('data-dmid', $(this).attr('id'));
                        $(this).parent().parent().find('span').text($(this).text());
                        $(this).parent().parent().children('img').attr('src', '../img/prl-select.jpg')
                        $(this).parent().css('display','none');
                    });
                },
                error: function(err) {
                    console.log(err);
                }
            })
        }
        //删除扣款项目
        function dele_thisclk(obj){
            $(obj).parents(".kk_thislist").remove();
            kkallback_money=0;
            $(".kk_money").each(function(){
                kkallback_money += Number($(this).val())
            });
            
            $(".tab3_kk").attr("data-money",kkallback_money);
            var all_zzf = Number($(".zongji_money").html())-Number($(".tab1_yfk").attr("data-money"))-Number($(".tab2_ddxx").attr("data-money"))-Number($(".tab3_kk").attr("data-money"));
            $(".zongzhifu_money").html(all_zzf.toFixed(2));
            $(".shuihou_money").html((all_zzf*(1-ggsl)).toFixed(2));
            $(".all_jsje").val((all_zzf*(1-ggsl)).toFixed(2));
        }

        



        //结算
        
        $("#myradio1").on("click",function(){
            $(".gz_ticheng").hide().find(".ticheng").val('');
            $(".gz_xianjin").html('现&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;金：').next(".xianjin").val('');
            $(".sjjs_allmoney").find("span").html('实际现结：');
            $(".sjjs_allmoney").find("input").html('');

            $(".daijinquan_type").html('');
            $(".qr_clxx span").css("background","#6ba1ff");
            $(".btn_queren").css("background","#6ba1ff");
            add_djqclk();
        })
        $("#myradio2").on("click",function(){
            $(".gz_ticheng").show().find(".ticheng").val('');
            $(".gz_xianjin").html('工&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;资：').next(".xianjin").val('');
            $(".sjjs_allmoney").find("span").html('实际工资：');
            $(".sjjs_allmoney").find("input").html('');

            $(".daijinquan_type").html('');
            $(".qr_clxx span").css("background","#6ba1ff");
            $(".btn_queren").css("background","#6ba1ff");
            add_djqclk();
        })
        //结算新增代金券
        var isFrist4 = true;
        $(".tab4_js").on("click",function(){
            if(!isFrist4){
                return;
            }
            add_djqclk();
            isFrist4 = false;
        })
       
        function add_djqclk(b){
            $(b).hide();
            $(b).next().show();
            $.ajax({
                url: pubIP + 'order/queryTCouponInfor',
                type: 'get',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    companyId: '1',
                },
                cache: false,
                dataType: 'json',
                success: function (data) {
                    console.log("++++++++++++------------------+++++++++++++++");
                    console.log(data);
                    var data = data.data;
                    var str4 = '';
                    var str5 = '';
                    $.each(data,function(idx,item){
                        str4 += '<li data-index="'+idx+'" id="'+item.id+'" dotId="'+item.dot_id+'" >'+item.coupon_name+'</li>';
                    })
                    str5+='<li class="dj_thislist">'
                    str5+='<div class="lf lfdj_select">'
                    str5+='<span>代&nbsp;&nbsp;金&nbsp; 券：</span>'
                    str5+='<div class="goodsType input select myselect2" style="float: none;margin-top: 0px; margin-right: 0px; margin-left: 8px;" data-selectedindex="-1"><span class="all_djq">请选择</span><img src="../img/prl-select.jpg" >'
                    str5+='<ul style="top: 35px;">'+str4+'</ul>'
                    str5+='</div>'
                    str5+='</div>'
                    str5+='<div class="inp_daijinquan fr">'
                    str5+='<input class="dj_money jiajia" type="text" placeholder="请输入代金券金额">'
                    str5+='<span class="add_this2" onclick="add_djqclk(this)">增加代金券</span>'
                    str5+='<span style="display: none;" class="dele_this2" onclick="dele_djqclk(this)">删除代金券</span>'
                    str5+='</div>'
                    str5+='</li>'
                    $(".daijinquan_type").append(str5);
                     
                    //现金 //提成//工资
                    $(".jiajia").unbind();
                    $(".jiajia").on("input",function(){
                        var jiesuanAll = Number($(".all_jsje").val()).toFixed(0);//税后金额
                        var jiajia = Number($(".xianjin").val())+Number($(".ticheng").val());//工资+提成或者现金
                        var kkallback_money=0;//所有代金券的金额
                        $(".dj_money").each(function(){
                            kkallback_money += Number($(this).val());
                        });
                        if(jiajia+kkallback_money>jiesuanAll){
                            window.parent.$(".all_error_alert").show();
                            window.parent.$(".all_error_alert").find(".innerErrmsg").html("实际金额不能大于结算金额");
                            // $(".qr_clxx span").css("background","#666");
                            // $(".btn_queren").css("background","#666");
                            $(this).val('');
                            $(".sjjs_allmoney input").val("");
                        }else{
                            $(".sjjs_allmoney input").val(jiajia+kkallback_money);
                        }
                    })
                    // 模拟下拉框
                    $(".select").unbind();//解除所有绑定事件 再重新注册
                    $('.select').click(function(event){
                        if($(this).attr("disabled")=="disabled"){return;}//不可选
                        if($(this).children('img').attr('src') == '../img/prl-selected.jpg'){
                            $(this).children('img').attr('src', '../img/prl-select.jpg')
                        } else {
                            $(this).children('img').attr('src', '../img/prl-selected.jpg')
                        }
                        event.stopPropagation();
                        $(this).children('ul').toggle();
                        var that = $(this);
                        that.find('li').each(function(){
                            $(this).mouseover(function(){
                                $(this).addClass('hovered')
                            });
                            $(this).mouseleave(function(){
                                $(this).removeClass('hovered')
                            });
                            if($(this).attr('data-index') == that.attr('data-selectedindex')){
                                $(this).css({'background': '#6ea3ff','color': '#fff'});
                                $(this).siblings('li').css({'background': '#fff','color': '#999'});
                            }
                        });
                    }).mouseleave(function (event) {
                        $(this).children('img').attr('src', '../img/prl-select.jpg');
                        $(this).children('ul').hide();
                    });
                    $('.select ul li').click(function(){
                        event.stopPropagation();
                        $(this).parent().parent().attr('data-selectedindex', $(this).attr('data-index'));
                        $(this).parent().parent().find('span').attr('data-couponId', $(this).attr('id'));//券id  couponId
                        $(this).parent().parent().find('span').attr('data-dotId', $(this).attr('dotId'));//结算网点id
                        $(this).parent().parent().find('span').text($(this).text());
                        $(this).parent().parent().children('img').attr('src', '../img/prl-select.jpg')
                        $(this).parent().css('display','none');
                    });
                },
                error: function(err) {
                    console.log(err);
                }
            })
        }
        //删除代金券
        function dele_djqclk(obj){
            $(obj).parents(".dj_thislist").remove();
        }

        //确认送达结算工资

        $(".qr_clxx span").on("click",function(){
           
             //车辆对象
            var car = {};
            car.driverid = $(".order_info_ul2 li.active").attr("id");//司机id
            car.id = $(".order_info_ul2 li.active").attr("data-ids");
            car.carid = $(".order_info_ul2 li.active").attr("data-carid");
            car.departureNo = $(".xx_fhdh").val();//发货单号
            car.departureDate = $(".xx_fhsj").val();//发货日期
            car.departureNum = $(".xx_zzjs").val();//发车重量
            car.departurePrice = $(".xx_jcj").val();//结车价
            car.departureLoss = $(".xx_ksl").val();//	扣损率
            car.departureLossPrice = $(".xx_ksdj").val();//扣损单价
            car.departureAttr = $(".upload_div_hide1").val();//发货磅单
            car.returnNo = $(".xx_scdh").val();//收车单号
            car.returnNum = $(".xx_sczl").val();//收车(重量/体积)
            car.returnDate = $("#test2").val();//	收车日期
            car.returnAttr = $(".upload_div_hide2").val();//	收车磅单
            car.settlementAmount = $("#test2").val();//	结算金额
            car.money = $(".yufujin").html();//	预付金 金额
            car.returnMoney= $(".yufujin_back").val();//	预付金返还金额
            var carstr = JSON.stringify(car);
            //console.log(carstr,"111111111111111111111111111");

            //扣款项数组
            var deductMoneyList = [];
            $(".all_kkx").each(function(idx,item){
                var aa = {};
                aa.companyId = '1';//	公司主键
                if(item.innerHTML!= '请选择'){
                    aa.dmid = item.getAttribute("data-dmid");//扣款项Id
                    aa.name = item.innerHTML;//扣款名称
                    aa.value = $(".kk_money").eq(idx).val();//扣款金额
                    deductMoneyList.push(aa);
                }
                
            })
            var deductMoneyListstr=JSON.stringify(deductMoneyList);
            //console.log(deductMoneyListstr,"22222222222222222222222222222");

            //代金券数组
            var settlementCardList = [];
            $(".all_djq").each(function(idx,item){
                var aa = {};
                if(item.innerHTML!= '请选择'){
                    aa.couponId = item.getAttribute("data-couponId");//代金券id
                    aa.dotId = item.getAttribute("data-dotId");//结算网点id
                    aa.companyId = companyId;//企业id
                    aa.money = $(".dj_money").eq(idx).val();//代金券金额
                    aa.driverId = $(".order_info_ul2 li.active").attr("id");//司机id  
                    aa.attr1 = $(".order_info_ul2 li.active").attr("data-tLogisticsOrderId");//订单主键
                    settlementCardList.push(aa);
                }
            })
            var settlementCardListstr=JSON.stringify(settlementCardList);
            //console.log(settlementCardListstr,"33333333333333333333333333333");

            //返还预付款
            var cardList = [];
            $(".quan_backmoneys").each(function(idx,item){
                var aa = {};
                aa.cardId = item.getAttribute("id");//返还卡id
                aa.amount = $(".quan_backmoneys").eq(idx).val();//返还卡金额
                cardList.push(aa);
            })
            var cardListstr=JSON.stringify(cardList);
            //console.log(cardListstr,"444444444444444444444444444444444444444");
            
            //结算接口
            $.ajax({
                url: pubIP + 'order/upCarUserById',
                type: 'post',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    companyId: '1',
                    extractMoney: $(".ticheng").val(),
                    grantMoney: $(".xianjin").val(),//该字段
                    orderNo: tloId,
                    tLogisticsOrderId: tloId,
                    tlvType: $(".order_info_ul2 li.active").attr("data-type"),
                    type: $(".order_info_ul2 li.active").attr("data-type"),
                    car: carstr,
                    deductMoneyList: deductMoneyListstr,
                    settlementCardList: settlementCardListstr,
                    cardList: cardListstr,
                },
                cache: false,
                dataType: 'json',
                success: function (data) {
                    console.log("++++++++++++------------------+++++++++++++++");
                    console.log(data);
                    window.parent.$(".all_error_alert").show();
                    window.parent.$(".all_error_alert").find(".innerErrmsg").html("结算成功");
                    huoqu_msg();
                },
                error: function(err) {
                    console.log(err);
                }
            })
        })
        
        
        
        $(".tablea").find(".box:first").show();    //为每个BOX的第一个元素显示       
        $("#oranger li").on("click",function(){ //给a标签添加事件  
            var index=$(this).index();  //获取当前a标签的个数  
            $(this).parent().next().find(".box").hide().eq(index).show(); //返回上一层，在下面查找css名为box隐藏，然后选中的显示  
            $(this).addClass("hover").siblings().removeClass("hover"); //a标签显示，同辈元素隐藏

        });
        //关闭弹窗
        $("img.close").on("click",function(){
            window.parent.$(".modelBox18_ifrm").hide();
        })
    </script>
</body>
</html>