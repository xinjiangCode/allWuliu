<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" CONTENT="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta name="format-detection" content="telephone=no" />
    <title>新疆物流服务平台</title>
    <link rel="stylesheet" type="text/css" href="../css/commin.css"/>
    <link rel="stylesheet" href="../css/require_style/publishRequireList-detail.css">
    <style>
        /* baojiaCompany */
        .baojiaCompany>.contBox{
            overflow: hidden;
        }
        .baojiaCompany .ll{
            width: 327px;
        }
        .baojiaCompany .mm{
            width: 320px;
        }
        .baojiaCompany .rr{
            width: 285px;
        }
        .baojiaCompany .rr .select{
            margin-right: 15px;
        }
        /* operator */
        .operator>.contBox{
            overflow: hidden;
        }
        .operator .ll{
            width: 327px;
        }
        .operator .mm{
            width: 320px;
        }
        .operator .rr{
            width: 285px;
        }
        /* 点击查看合同 */
        div.seehetong {
            float: right;
            width: 48px;
            margin-right: 28px;
            cursor: pointer;
            font-size: 14px;
            color: #038cd9;
            background-image: url(../img/prl-right.png);
            background-size: 9px 7px;
            background-repeat: no-repeat;
            background-position: right center;
        }

        /*.contbox-prld {
            height: 1372px;
            overflow-y: auto;
            overflow-x: hidden;
        }*/

        #carInfo {
            /*height: 85px;*/
            overflow: hidden;
            overflow-y: auto;
        }

        /*.contlisttwo .ll, .contlistone .ll, .operator .ll, .baojiaCompany .ll, .dangerIntroduce .ll {
            width: 305px;
        }

        .companyInfo .ll {
            width: 303px;
        }*/
        .contbox-prld{
            height: 1150px;
            overflow-x: hidden;
            overflow-y: scroll;
            /*padding-bottom: 200px;*/
        }
        .operator .blue{
            color: #0072bc;
            margin: 0 5px;
        }
        .listBox tr{
            border-bottom: 1px solid #eeeeee;
        }
        .listBox td{
            text-align: center;
        }
    </style>
</head>
<body>
<div class="contbox-prld">
    <div class="toptitle title">
        <span id="detailTitle">当前订单状态：进行中订单</span>
        <div class="fr closeBtn" style="margin-right:7px;" onclick="javascript:history.back(-1);"><img src="../img/prl-close.png" alt="" width="11" height="11">关&nbsp;&nbsp;闭</div>
        <!--<div class="fr freshBtn cfRefresh"><img src="../img/prl-refresh.png" alt="" width="27" height="34">刷&nbsp;&nbsp;新</div>-->
    </div>

    <div class="requireInfo infoBox">
        <div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">订单信息</div>
        <div class="contBox" id="orderInfo">
            <!-- <div class="contlist contlistone">
                <div class="left ll">
                    <div>订单编号：<span>201707196369321</span></div>
                    <div>发布时间：<span>2015-09-08 23:00</span></div>
                    <div>装车时间：<span>2015-09-08 23:00</span></div>
                </div>
                <div class="left rr">
                    <div>始&nbsp;&nbsp;发&nbsp;&nbsp;地：<span>新疆-乌鲁木齐-xxxx区-xxxx路-xxxx号xxx详情</span></div>
                    <div class="desti">目&nbsp;&nbsp;的&nbsp;&nbsp;地：<span class="destination">新疆-乌鲁木齐-xxxx区-xxxx路-xxxx号xxx详情中华人民共和国北京市东城区朝阳花园</span></div>
                </div>
            </div>
            <div class="contlist contlisttwo">
                <div class="left ll">
                    <div>：<span>危化</span></div>
                    <div>重&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;量：<span>150吨</span></div>
                    <div>支付方式：预付</div>
                    <div>保&nbsp;&nbsp;证&nbsp;&nbsp;金：<span>¥1000.00</span></div>
                </div>
                <div class="left mm">
                    <div>包装类型：<span>罐装</span></div>
                    <div>开&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;票：<span>普票</span></div>
                    <div>结算方式：<span>现汇</span></div>
                    <div>缴纳方式：<span>抵扣</span></div>
                </div>
                <div class="left rr">
                    <div>货物名称：<span>片碱</span></span></div>
                    <div>车辆类型：<span>罐装车</span></span></div>
                    <div>回&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;单：<span>需要</span></span></div>
                    <div>备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：<span>备注信息</span></div>
                </div>
            </div> -->
        </div>
    </div>
    <!--危险品介绍二期-->
    <div class="dangerIntroduce infoBox" style="display: none;" >
        <div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">危险品介绍<div class="look_more_info"><a href="##">查看更多信息</a></div></div>
        <div class="contBox">
            <div class="left ll">名&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;称：<span>片碱</span></div>
            <div class="left mm">学&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名：<span>氢氧化钠</span></div>
            <div class="left rr">危险等级：<span>重度危险</span></div>
        </div>
    </div>
    <div class="companyInfo infoBox">
        <div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">企业信息</div>
        <div class="contBox" id="qiyeInfo">
            <!-- <ul>
                <li class="left ll">发货公司：<span class="blue">化动力有限公司</span></li>
                <li class="left mm">联&nbsp;&nbsp;系&nbsp;&nbsp;人：<span>王小二</span></li>
                <li class="left rr">联系电话：<span>18500000000</span></li>
                <li>详细地址：<span>新疆-乌鲁木齐-xxxx区-xxxx路-xxxx号xxx详情</span></li>
            </ul>
            <ul>
                <li class="left ll">发货公司：<span class="blue">化动力有限公司</span></li>
                <li class="left mm">联&nbsp;&nbsp;系&nbsp;&nbsp;人：<span>王小二</span></li>
                <li class="left rr">联系电话：<span>18500000000</span></li>
                <li>详细地址：<span>新疆-乌鲁木齐-xxxx区-xxxx路-xxxx号xxx详情</span></li>
            </ul> -->
        </div>
    </div>
    <!--搬砖工说没有-->
    <div class="baojiaCompany infoBox" style="display: none;">
        <div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">物流公司</div>
        <div class="contBox">
            <ul>
                <li class="left ll">发货公司：<span class="blue wuliu_info_companyname">化动力有限公司</span></li>
                <li class="left mm">联&nbsp;&nbsp;系&nbsp;&nbsp;人：<span class="wuliu_info_user">王小二</span></li>
                <li class="left rr">联系电话：<span class="wuliu_info_phone">18500000000</span></li>
                <li>详细地址：<span class="wuliu_info_address">新疆-乌鲁木齐-xxxx区-xxxx路-xxxx号xxx详情</span></li>
            </ul>
        </div>
    </div>
    <div class="operator infoBox">
        <div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">车辆信息</div>
        <div class="contBox" id="carInfo">

        </div>
    </div>
    <div class="operator infoBox">
        <div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">操作人员</div>
        <div class="contBox">
            <div class="left ll">
                <div>接&nbsp;&nbsp;单&nbsp;&nbsp;人：<span class="jiedan_person"></span></div>
            </div>
            <div class="left mm">
                <div>发单人员：<span class="fadan_person"></span></div>
            </div>
        </div>
    </div>
    <div class="operator infoBox">
        <div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">金额管理</div>
        <div class="contBox">
            <div class="left ll">
                <!-- <div>合同保证金：<span>10000.00</span></div> -->
                <div>结算金额：<span class="jiesuan_money">10000.00</span></div>
            </div>
            <div class="left mm">
                <!-- <div>回款保证金：<span>10000.00</span></div> -->
                <div>确认结算金额：<span class="queren_jiesuan_money">10000.00</span></div>
            </div>
            <div class="left rr">
                <div>确认收货时间：<span class="ok_shouhuo_time">2015-09-08 12：20</span></div>
            </div>
        </div>
    </div>
    <div class="operator infoBox heTong">
        <div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">合同信息<div class="seehetong"><a onclick="down_moban(this)" href="javaScript:;" >查&nbsp;&nbsp;看</a></div></div>
        <div class="contBox">
            <div class="left ll">
                <div>合同公司：<span class="hetong_company">化动力有限公司</span></div>
            </div>
            <div class="left mm">
                <div>签订时间：<span class="qianding_time">2015-09-08 12：20</span></div>
            </div>
            <div class="left rr">
                <div>上传时间：<span class="upload_time">2015-09-08 12：20</span></div>
            </div>
        </div>
    </div>
    <div class="operator infoBox">
        <div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">发票信息</div>
        <div class="contBox">
            <div class="left ll">
                <div>纳税识别号：<span class="nashui">100000.00</span></div>
                <div>企业银行账户：<span class="qiye_bank">100000.00</span></div>
            </div>
            <div class="left mm">
                <div>企业电话：<span class="qiye_phone">1201509081220</span></div>
                <div>地&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;址：<span class="address">1201509081220</span></div>
            </div>
            <div class="left rr">
                <div>企业开户银行：<span class="qiye_kaihu_bank">2015-09-08 12：20</span></div>
            </div>
        </div>
        <div class="operator orderList">
            <div class="title"><img src="../img/prl-titlelogo.png" width="29" height="28" alt="">子订单列表</div>
            <div class="contBox" style="padding: 0;">
                <div class="listBox" style="overflow-x: scroll;" >
                    <table style="width:1500px;">
                        <thead>
                        <tr>
                            <th>订单编号</th>
                            <th>公司名称</th>
                            <th>订单类型</th>
                            <th>已运单数</th>
                            <th>总金额</th>
                            <th>待结金额</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody >
                        </tbody>
                    </table>
                </div>
                <div class="" style="text-align: center;height: 75px;padding-top: 17px;margin-bottom: 0;border-top: 1px solid #ebe9ea;">
                    <ul class="pagination" id="page1" style="position: static;margin-bottom: 0;"></ul>
                    <div class="pageJump">
                        <span class="allPageN"></span>
                        <i style="margin-left: 12px;"></i>，
                        <span>到第</span>
                        <input type="text"/>
                        <span>页</span>
                        <button type="button" class="button">GO</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<script src="../js/jquery-3.2.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/pager.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/common.js?v=201811151239" type="text/javascript" charset="utf-8"></script>
<script src="../js/template.js" type="text/javascript" charset="utf-8"></script>
<script type="text/html" id="orderTpl">
    <div class="contlist contlistone">
        <div class="left ll">
            <div><span>订单编号：</span><span title="<%=orderNo%>" style=" width: 225px;text-overflow: ellipsis;white-space: nowrap; overflow: hidden;vertical-align: bottom;"><%=orderNo%></span></div>
            <div>发布时间：<span><%=createTime%></span></div>
            <div>装车时间：<span><%=startDate%></span></div>
        </div>
        <div class="left rr">
            <div>始&nbsp;&nbsp;发&nbsp;&nbsp;地：<span><%=sendProvince%><%=sendCity%><%=sendArea%><%=sendAddress%></span></div>
            <div class="desti">目&nbsp;&nbsp;的&nbsp;&nbsp;地：<span class="destination"><%=receiveProvince%><%=receiveCity%><%=receiveArea%><%=receiveAddress%></span></div>
        </div>
    </div>
    <div class="contlist contlisttwo">
        <div class="left ll">
            <div>化学品名：<span><%=chemicalName%></span></div>
            <div>重&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;量：<span><%=goodsNum%><%=goodsUnit%></span></div>
            <div>支付方式：<%=paymentType%></div>
            <!-- <div>保&nbsp;&nbsp;证&nbsp;&nbsp;金：<span>¥1000.00</span></div> -->
            <div>订单类型：<span id="orderType"><%=orderType%></span ></div>
            <div>发单类型：<span id="demandType"><%=demandType%></span></div>
        </div>
        <div class="left mm">
            <div>包装类型：<span>罐装</span></div>
            <div>开&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;票：<span><%=invoiceType%></span></div>
            <div>备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：<span><%=goodsRemark%></span></div>
            <!-- <div>结算方式：<span><%=paymentMode%></span></div> -->
            <!-- <div>缴纳方式：<span>抵扣</span></div> -->
            <div>车辆要求：<span id="carLWH"><%=carLWH%></span></div>
            <div>需求有效期：<span id="demandEndTime1"><%=demandEndTime%></span></div>
        </div>
        <div class="left rr">
            <div>货物名称：<span><%=goodsName%></span></div>
            <div>车辆类型：<span><%=carType%></span></div>
            <!-- <div>回&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;单：
            <%if (receipt == 0) {%>
            <span>不需要</span>
            <%} else if(receipt == 1) {%>
            <span>需要</span>
            <%}%>
            </div> -->
            <div>期望运价：<span id="wishUnitPrice"><%=wishUnitPrice%></span></div>
            <div>发货时间：<span id="startDate"><%=startDate%></span></div>
            <div>预计到货时间：<span id="planEndDate"><%=planEndDate%></span></div>
        </div>
    </div>
</script>
<script type="text/html" id="qiyeTpl">
    <ul>
        <li class="left ll">发货公司：<span class="blue"><%=sendCompanyName%></span></li>
        <li class="left mm">联&nbsp;&nbsp;系&nbsp;&nbsp;人：<span><%=sendUser%></span></li>
        <li class="left rr">联系电话：<span><%=sendPhone%></span></li>
        <li>详细地址：<span><%=sendProvince%><%=sendCity%><%=sendArea%><%=sendAddress%></span></li>
    </ul>
    <ul>
        <li class="left ll">收货公司：<span class="blue"><%=receiveCompanyName%></span></li>
        <li class="left mm">联&nbsp;&nbsp;系&nbsp;&nbsp;人：<span><%=receiveUser%></span></li>
        <li class="left rr">联系电话：<span><%=receivePhone%></span></li>
        <li>详细地址：<span><%=receiveProvince%><%=receiveCity%><%=receiveArea%><%=receiveAddress%></span></li>
    </ul>
</script>

<script type="text/html" id="carTpl">
    <%for (i in list1) {%>
    <div>
        <div class="left ll" style="width: 300px;">
            <div>车&nbsp;&nbsp;牌&nbsp;&nbsp;号：<span class="car_no"><%=list1[i].carNo%></span></div>
            <!-- <div>状&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;态：<span class="status_name"><%=list1[i].status%></span></div> -->
        </div>
        <div class="left mm">
            <div>分配时间：<span class="fenpei_time"><%=list1[i].planStartDate%></span></div>
            <!-- <div>磅&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;单：<span style="color:#6ba1ff;cursor: pointer;">查&nbsp;&nbsp;看</span></div> -->
        </div>
        <div class="left rr">
            <div>预计到达：<span class="yuji_time"><%=list1[i].planEndDate%></span></div>
        </div>
    </div>
    <%}%>
</script>
<script>
    //Iframe 的高度
    $(function () {
        window.parent.$("#Iframe").css("height","1450");

        if ($('.contbox-prld').height() > 1372) {
            $('.contbox-prld').css('width', '988px');
        }
    })
    $("#detailTitle").text(sessionStorage.getItem("detailTitle"))

    $(document).on('click', '.look_more_info', function() {
        window.parent.location.href = '../../dangerousGoods_detail.html';
    });

    $("#orderTitle").text(window.localStorage.getItem('data-title'));
    // 订单id
    var tloId = window.localStorage.getItem('data-tloId');

    //订单编号
    var orderNo = window.localStorage.getItem('data-orderNo');

    //危化品id
    var dataCompanyId = window.localStorage.getItem('data-companyId');
    if(dataCompanyId ==""){
        $(".heTong").hide();
    }else{
        $(".heTong").show();
        getFaPiao();
    }
    getDetail()
    getCar()
    getHeTong()


    if(sessionStorage.getItem("isTotalOrderDetail")=="1"){
        $(".orderList").show()
        getData(1);
    }else{
        $(".orderList").hide()
    }
    // 详情信息
    function getDetail(){
        $.ajax({
            url: pubIP + 'order/getOrderByid',
            type: 'get',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                tloid: tloId
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);

                if (json.code == 1) {

                    if(json.data.createTime==null){
                        json.data.createTime="无";
                    }else{
                        json.data.createTime = new Date(json.data.createTime).Format("yyyy-MM-dd hh:mm:ss");
                    }
                    if(json.data.startDate==null){
                        json.data.startDate="无";
                    }else{
                        json.data.startDate = new Date(json.data.startDate).Format("yyyy-MM-dd hh:mm:ss");
                    }

                    if(json.data.orderType==null){
                        $("#orderType").text("");
                    }
                    if(json.data.wishUnitPrice==null){
//                        $("#wishUnitPrice").text("");
                        json.data.wishUnitPrice="";
                    }else{
                        json.data.wishUnitPrice=json.data.wishUnitPrice+"元/"+json.data.goodsUnit;
                    }
                    if(json.data.carHeight!=null && json.data.carLength!=null && json.data.carWeight!=null){
                        json.data.carLWH=data.carLength+" * "+data.carWeight+" * "+data.carHeight;
                    }else{
                        json.data.carLWH="";
                    }
                    if(json.data.startDate==null){
                        json.data.startDate=="";
                    }else{
                        json.data.startDate=timestampToTime1(json.data.startDate)
                    }
                    if(json.data.demandType==null){
                        json.data.demandType="";
                    }
                    if(json.data.demandEndTime==null){
                        json.data.demandEndTime="";
                    }else{
                        json.data.demandEndTime=timestampToTime1(json.data.demandEndTime);
                    }
                    if(json.data.planEndDate==null){
                        json.data.planEndDate="";
                    }else{
                        json.data.planEndDate=timestampToTime1(json.data.planEndDate);
                    }

                    var orderResult = template('orderTpl', json.data);
                    $('#orderInfo').html(orderResult);

                    var qiyeResult = template('qiyeTpl', json.data);
                    $('#qiyeInfo').html(qiyeResult);

                    $('.wuliu_info_companyname').text(json.data.sendCompanyName);
                    $('.wuliu_info_user').text(json.data.sendUser);
                    $('.wuliu_info_phone').text(json.data.sendPhone);
                    $('.wuliu_info_address').text(json.data.sendAddress);

                    $('.fadan_person').text(json.data.invoiceUser);
                    $('.jiedan_person').text(json.data.receiptUser);

                    $('.car_no').text(json.data.carNo);


//                    金额管理部分
                    if(json.data.updateTime!=null && json.data.updateTime!=""){
                        $('.ok_shouhuo_time').text(timestampToTime1(json.data.updateTime));
                    }else{
                        $('.ok_shouhuo_time').text("");
                    }
                    if(json.data.tloContractAmount!=null && json.data.tloContractAmount!=""){
                        $('.jiesuan_money').text(json.data.tloContractAmount);
                    }else{
                        $('.jiesuan_money').text("");
                    }
                    if(json.data.tlosettlementAmount!=null && json.data.tlosettlementAmount!=""){
                        $('.queren_jiesuan_money').text(json.data.tlosettlementAmount);
                    }else{
                        $('.queren_jiesuan_money').text("");
                    }



//                    操作人员
                    if(json.data.invoiceUser!=null && json.data.invoiceUser!=""){
                        $(".jiedan_person").text(json.data.invoiceUser)
                    }else{
                        $(".jiedan_person").text("")
                    }


                    if(json.data.receiveUser!=null && json.data.receiveUser!=""){
                        $(".fadan_person").text(json.data.receiveUser)
                    }else{
                        $(".fadan_person").text("")
                    }

                }

            },
            error: function(err) {
                console.log(err);
            }

        });
    }

    //车辆信息
    function getCar() {
        $.ajax({
            url: pubIP + 'order/getCarUserListByOrderId',
            type: 'get',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                orderId: tloId
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                if (json.code == 1) {
                    if(json.data==null || json.data=="" || json.data.length==0){
                        $("#carInfo").parents(".operator").hide();
                    }else{
                        $("#carInfo").parents(".operator").show();
                    }
                    for (var i = 0; i < json.data.length; i++) {
                        json.data[i].planStartDate = new Date(json.data[i].planStartDate).Format("yyyy-MM-dd hh:mm:ss");
                        json.data[i].planEndDate = new Date(json.data[i].planEndDate).Format("yyyy-MM-dd hh:mm:ss");
                    }
                    var carResult = template('carTpl', {list1: json.data});
                    $('#carInfo').html(carResult);

                    window.parent.$("#Iframe").css("height", Number(1213)+30*Number(json.data.length-1));

                }

            },
            error: function(err) {
                console.log(err);
            }

        });
    }

    // 合同信息
    function getHeTong() {
        $.ajax({
            url: pubIP + 'tContractTrade/selectByOrderNo',
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                orderNo: orderNo
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);

                if (json.code == 1) {
                    if(json.data!=null){
                        if(json.data.createTime==null){
                            json.data.createTime="无";
                        }else{
                            json.data.createTime = new Date(json.data.createTime).Format("yyyy-MM-dd");
                        }
                        if(json.data.signDate==null){
                            json.data.signDate="无";
                        }else{
                            json.data.signDate = new Date(json.data.signDate).Format("yyyy-MM-dd");
                        }

                        $('.hetong_company').text(json.data.receiveCompanyname);
                        $('.qianding_time').text(json.data.signDate);
                        $('.upload_time').text(json.data.createTime);
                        $(".heTong").show()
                    }else{
                        $(".heTong").hide()
                        $('.hetong_company').text("");
                        $('.qianding_time').text("");
                        $('.upload_time').text("");
                    }

                    $('.seehetong a').attr('data-download', json.data2.url);
                }

            },
            error: function(err) {
                console.log(err);
            }

        });
    }

    // 发票信息
    function getFaPiao() {
        $.ajax({
            url: pubIP + 'order/queryInvoiceInfo',
            type: 'get',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                companyId: dataCompanyId
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);

                if (json.code == 1) {

                    $('.nashui').text(json.data.taxId);
                    $('.qiye_phone').text(json.data.taxNumber);
                    $('.qiye_kaihu_bank').text(json.data.accountBank);
                    $('.qiye_bank').text(json.data.accountId);
                    $('.address').text(json.data.companyAddress);
                }

            },
            error: function(err) {
                console.log(err);
            }

        });
    }



    //获取定单列表数据
    function getData(currentPage) {
        $(".listBox tbody").html("");
        $.ajax({
            url: pubIP + 'order/getMoreOrderList', /*v1.0*/
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            cache: false,
            ansyc: true,
            dataType: 'json',
            data:{
                status:1,//公司类型 0 供应商 1 承运商
                size:pageSize,
                page:currentPage,
                parentId:tloId
            },
            success: function (res) {
                if(res.code==1){
                    //首次请求时 改变分页数据
                    if(res.data==null || res.data.length==0){ $(".listBox tbody").html("");$(".pagination").parent().css("display","none"); return;}
                    $(".pagination").parent().css("display","block");
                    if(currentPage==1){
//                        window.parent.$("#Iframe").css("height","1834");
                        //修改底部分页
                        var pageNum=Math.ceil(res.count/pageSize);
                        $(".allPageN").attr("pageTotal",pageNum);
                        $(".pageJump i").text("共"+pageNum+"页,"+"共"+res.count+"条");
                        $('.objListBox>div:nth-child(5n)').css('margin-right','0');
                        Page({
                            num: pageNum,
                            elem: $('#page1'),
                            callback: function(n) {
                                // console.log(n);
                                getData(n);//加载n页数据
                            }
                        });
                    }
                    //修改底部页数
                    $(".allPageN").text((currentPage)+"/"+ $(".allPageN").attr("pageTotal"));

                    cf_dataRender(res.data)
                }else{

                }
            },
            error: function(err){
                console.log(err);
            }
        });
    }
    //渲染数据
    function cf_dataRender(data) {
        var str='';
        $.each(data,function (idx,item) {
            str+='<tr data-id="'+item.tloId+'" data-tloId="'+item.tloId+'" data-demandId="'+item.demandId+'" data-companyId="'+item.companyId+'"  data-orderNo="'+item.orderNo+'" data-companyname="'+item.companyName+'" data-quotesSatus="'+item.goodsType+'" data-tloContractAmount="'+item.unitPrice+'"  data-tloContractAmount="'+item.tloContractAmount+'"  data-danjia="'+item.unitPrice+'" data-num="'+item.goodsNum+'"  data-sendCompanyId="'+item.sendCompanyId+'" data-sendCompanyName="'+item.sendCompanyName+'" data-receiveCompanyId="'+item.receiveCompanyId+'" data-receiveCompanyName="'+item.receiveCompanyName+'" data-tloContractAmount="'+item.tloContractAmount+'" data-tlosettlementAmount="'+item.tlosettlementAmount+'" data-tloId="'+item.tloId+'">';
            str+='<td>'+item.orderNo+'</td>';
            str+='<td>'+item.carrierCompanyName+'</td>';
            str+='<td>'+item.orderType+'</td>';
            str+='<td>'+' '+'</td>';
            if(item.tlosettlementAmount==null){
                str+='<td>'+0+'</td>';
            }else{
                str+='<td>'+item.tlosettlementAmount+'</td>';
            }
            str+='<td>'+''+'</td>';
            if(item.tloStatus==	1 || item.tloStatus==2 || item.tloStatus==3){   //未签约	0	ORDER_STATUS_UNSIGNED	供应商未确认承运商`
                str+=' <td><span class="blue seeDetail">查看订单</span><span class="blue" onclick="fenPei(\''+item.tloId+'\')">分配车辆</span><span class="blue cancel_order">取消订单</span><span class="blue update">上传合同</span><span class="blue diaoling">发起调令</span>';
            }else if(item.tloStatus==4){//进行中订单
                str+=' <td><span class="blue seeDetail">查看订单</span><span class="blue sure">确认送达</span><span class="blue " onclick="fenPei(\''+item.tloId+'\')">更改车辆</span></td>';
            }else if(item.tloStatus==7){//回款审核订单
                str+=' <td><span class="blue seeDetail">查看订单</span><span class="blue huikuan_shenhe">回款审核</span></td>';
            }else if(item.tloStatus==5  || item.tloStatus==9 || item.tloStatus==10 || item.tloStatus==11 ){//回款审核订单
                str+=' <td><span class="blue">查看详情</span></td>';
            }else if(item.tloStatus==	6 || item.tloStatus==8){//财务待结算订单
                if(item.tLogisticsOrderstatus==8){
                    str+=' <td><span class="blue">查看详情</span><span onclick="updateStates(this)">修改状态</span></td>';
                }else{
                    str+=' <td><span class="blue">查看详情</span></td>';
                }
            }
            str+='</tr>';
        })
        $(".listBox tbody").html(str);
        //查看详情
        $(".seeDetail").unbind()
        $(".seeDetail").click(function () {
            window.localStorage.setItem('data-companyId', $(this).parents("tr").attr('data-companyId'));
            window.localStorage.setItem('data-tloId', $(this).parents("tr").attr('data-id'));
            window.localStorage.setItem('data-orderNo', $(this).parents("tr").attr('data-orderNo'));
            sessionStorage.setItem("detailTitle","订单详情");
            window.location.href = "orderAllDetail.html";
        })
        // 取消订单
        $(".cancel_order").unbind()
        $(".cancel_order").click(function() {
            $.ajax({
                url: ip + 'order/upCancelOrder',
                type: 'post',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    id: $(this).parents("tr").attr('data-tloId')
                },
                cache: false,
                dataType: 'json',
                success: function (json) {
                    if (json.code == 1) {
                        cf_alert(1,"订单取消成功!")
                    }
                },
                error: function(err) {
                    console.log(err);
                }
            });

        });

        //上传合同
       $('.update').unbind();
       $('.update').click( function() {
            $(".update").removeClass("thisUpdate");
            $(this).addClass("thisUpdate");
            $(window.parent.document).find('#qianding_time').val('')
            window.parent.$(".modelBox1 .errMsg").text("")
            $(window.parent.document).find('.modelBox1 input[type="hidden"]').val('')
            $(window.parent.document).find('.modelBox1 input[type="hidden"]').next().css('background', 'url("")')
            window.parent.showModelBox('.modelBox1');
        });
        window.parent.$(".ok_upload").unbind()
        window.parent.$(".ok_upload").click(function() {
            if(window.parent.$("#qianding_time").val()==""){
                window.parent.$(".modelBox1 .errMsg").text("请选择签订日期")
                return;
            }
            if(window.parent.$("#upload_hetong_hidden").val()==""){
                window.parent.$(".modelBox1 .errMsg").text("请上传合同")
                return;
            }
            window.parent.$(".modelBox1 .errMsg").text("")
            $.ajax({
                url: pubIP + 'tContractTrade/insertWLtContractTrade',
                type: 'post',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    orderid: $('.thisUpdate').parents('tr').attr('data-tloId'),
                    orderNo: $('.thisUpdate').parents('tr').attr('data-orderNo'),
                    sendCompanyid: $('.thisUpdate').parents('tr').attr('data-sendCompanyId'),
                    sendCompanyname: $('.thisUpdate').parents('tr').attr('data-sendCompanyName'),
                    receiveCompanyid: $('.thisUpdate').parents('tr').attr('data-receiveCompanyId'),
                    receiveCompanyname: $('.thisUpdate').parents('tr').attr('data-receiveCompanyName'),
                    url: $(window.parent.document).find('#upload_hetong_hidden').val(),
                    type: 1,
                    signDate: $(window.parent.document).find('.qianding_time').val()
                },
                cache: false,
                dataType: 'json',
                success: function (json) {
                    console.log(json);
                    if (json.code == 1) {
//                        $(window.parent.document).find('.modelBox1').css('display', 'none');
//                        $(window.parent.document).find('.modelBoxaddqita p span').html('合同上传成功！');
//                        window.parent.showModelBox('.modelBoxaddqita');
//                        window.location.reload();
                        cf_alert(1,"合同上传成功!")
                    }else{
                        cf_alert01(2,json.msg)
                    }

                },
                error: function(err) {
                    console.log(err);
                }
            });
        });
        // 发起调令
        $(".diaoling").unbind();
        $(".diaoling").click(function () {
            console.log($(this).attr('data-tloContractAmount'));
            $(window.parent.document).find('.ok_shenqing').attr('data-orderid', $(this).parents("tr").attr('data-orderId'));
            $(window.parent.document).find('.hetongyuanjia').text($(this).parents("tr").attr('data-tloContractAmount'));
            $(window.parent.document).find('.ok_shenqing').attr('data-companyname', $(this).parents("tr").attr('data-companyname'));
            $(window.parent.document).find('.ok_shenqing').attr('data-quotesSatus', $(this).parents("tr").attr('data-quotesSatus'));

            window.parent.showModelBox('.modelBox37');
        })
        window.parent.$(".modelBox37 .ok_shenqing").unbind();
        window.parent.$(".modelBox37 .ok_shenqing").click(function () {
            var orderid = $(this).parents("tr").attr('data-orderid');
            var companyname = $(this).parents("tr").attr('data-companyname');

            var quotesSatus = $(this).parents("tr").attr('data-quotesSatus');

            var oldPrice = $(window.parent.document).find('.hetongyuanjia').text();
            var quotedPrice = $(window.parent.document).find('.update_unit').val();
            var remark = $(window.parent.document).find('.tiaojia_yuanyin').val();

            $.ajax({
                url: pubIP + 'OrderPricesChanged/addCarrierPricesChanged',
                type: 'post',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    orderid: orderid,
                    companyid: companyId,
                    companyname: companyname,
                    quotesSatus: quotesSatus,
                    oldPrice: oldPrice,
                    quotedPrice: quotedPrice,
                    remark: remark
                },
                cache: false,
                dataType: 'json',
                success: function (json) {
                    console.log(json);
                    if (json.code == 1) {
                        $(window.parent.document).find('.modelBox37').css('display', 'none');
                        $('.update_unit').val('');
                        $('.tiaojia_yuanyin').val();
                        window.parent.showModelBox('.modelBoxdiaoling');

                        window.parent.$("#sureDiaoLingOver").click(function () {
                            window.location.reload();
                        })
                    }
                },
                error: function(err) {
                    console.log(err);
                }

            });
        })


        //确认送达
        $(".sure").unbind()
        $(".sure").click(function() {
            var tloId = $(this).parents("tr").attr('data-tloId');window.parent.$(".modelBox18_ifrm").attr("isDot","");
            sessionStorage.setItem("qrsd_tloId",tloId);
            window.parent.showModelBox('.modelBox18_ifrm');
            window.parent.$("#suerSongda").attr("src","order/querensongda.html");
        });

        // 回款审核
        $('.huikuan_shenhe').unbind()
        $('.huikuan_shenhe').click(function() {
            $(window.parent.document).find('.money_ok').attr('data-tloContractAmount', $(this).parents("tr").attr('data-tloContractAmount'));
            $(window.parent.document).find('.money_ok').attr('data-tlosettlementAmount', $(this).parents("tr").attr('data-tlosettlementAmount'));
            $(window.parent.document).find('.money_ok').attr('data-tloId', $(this).parents("tr").attr('data-tloId'));
            window.parent.$(".modelBox9 .hetong").text("¥"+$(this).parents("tr").parents("tr").attr('data-tloContractAmount'))
            window.parent.$(".modelBox9 .shiji").text("¥"+$(this).parents("tr").parents("tr").attr('data-tlosettlementAmount'))
            window.parent.showModelBox('.modelBox9');
        });

        // 点击弹框的确认
        window.parent.$('.money_ok').unbind()
        window.parent.$('.money_ok').click( function() {

            // var tlosettlementAmount = $(this).attr('data-tlosettlementAmount');
            // var tloContractAmount = $(this).attr('data-tloContractAmount');

            // var beizhu = $(window.parent.document).find('.beizhu_info').val();

            var tloId = $(this).parents("tr").attr('data-tloId');

            $.ajax({
                url: pubIP + 'order/receivedPayments',
                type: 'post',
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    id: tloId
                },
                cache: false,
                dataType: 'json',
                success: function (json) {
                    console.log(json);
                    if (json.code == 1) {
//                        window.parent.showModelBox('.ok_success');
//                        window.location.reload();
                        cf_alert(1,"审核成功")
                    }

                },
                error: function(err) {
                    console.log(err);
                }
            });

        });
    }
    // 点击go刷新数据
    $('.pageCont').on('click', '.button',function(){
        var currentPage1 = $('.pageCont li.active>a').text();
        getData(currentPage1);
    })
    //分配车辆
    function fenPei(id){
        window.parent.$(".modelBox17").show();
        window.parent.$(".modelBox17").attr("orderId",id);window.parent.$(".modelBox17").attr("isDot","");
        getData(id);
        window.parent.$("#ok_fenpei").hide();
        window.parent.$("#car_info").hide();
        window.parent.getPeoples(1);
        window.parent.getPeoples(2);
        window.parent.getPeoples(3);
        window.parent.getDataLine(1);
        //获取已选车  he  卡
        window.parent.getCarCard()
        window.parent.getKaQuanList();
    }
    //获取数据
    function getData1(id) {
        $.ajax({
            url: pubIP + 'order/getOrderByid', /*v1.0*/
            type: 'get',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            cache: false,
            ansyc: true,
            dataType: 'json',
            data:{
                tloid:id
            },
            success: function (res) {
                if(res.code==1){
                    cf_dataRender1(res.data)
                }else if(res.code==401){

                }else{
                    alert(res.msg);
                }
            },
            error: function(err){
                console.log(err);
            }
        });
    }
    //渲染上面数据
    function cf_dataRender1(data) {     //下需要重新写
        window.parent.$("#demandNo").text(data.demandNo);
        window.parent.$("#startDate").text(data.startDate);
        window.parent.$("#createTime").text(timestampToTime1(data.createTime));
        window.parent.$("#chemicalName").text(data.chemicalName);
        window.parent.$("#selectInput7").text(data.goodsType);
        window.parent.$("#packageType").text(data.packageType);
        window.parent.$("#goodsName").text(data.goodsName);
        window.parent.$("#goodsweight").eq(0).text(data.goodsNum+data.goodsUnit);
//              window.parent.$(".danjiadanwei").text("元/"+data.goodsUnit);
        window.parent.$("#sendAddress").text(data.sendProvince+"-"+data.sendCity+"-"+data.sendArea+"-"+data.sendAddress);
        window.parent.$("#receiveAddress").text(data.receiveProvince+"-"+data.receiveCity+"-"+data.receiveArea+"-"+data.receiveAddress);
        window.parent.$("#carType1").text(data.carType);
        window.parent.$("#paymentType1").text(data.paymentType);
        window.parent.$("#paymentType1").text(data.paymentType);
        window.parent.$("#invoiceType").text(data.invoiceType);
    }

    //修改订单状态  暂时
    function updateStates(that){
        $.ajax({
            url: pubIP + 'order/upOrderStatus',
            type: 'post',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            data: {
                status:9,
                tLogisticsOrderId:$(that).parents("tr").attr("data-id"),
                tLogisticsOrderstatus:8,
            },
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);

                if (json.code == 1) {
                    alert(json.msg)
                    window.location.reload();
                }

            },
            error: function(err) {
                console.log(err);
            }
        });
    }








    //下载协议模板
    function down_moban(that){
//        $.ajax({
//            url: pubIP + 'agreement/findAgreementInfo?agreementId=2',
//            type: 'get',
//            dataType: 'json',
//            success: function (data) {
//                //console.log(data);
                var thisUrl = $(that).attr("data-download")
                openWin("../generic/web/viewer.html?thisUrl="+thisUrl);
                //window.downloadFile(thisUrl);
//            },
//            error: function (err) {
//                console.log(err);
//            }
//        })
    }
    function openWin(url) {
        $('body').append($('<a href="' + url + '" target="_blank" id="openWin"></a>'))
        document.getElementById("openWin").click();//点击事件
        $('#openWin').remove();
    }

</script>
</body>
</html>